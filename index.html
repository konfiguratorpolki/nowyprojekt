<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DNBGJLP2FN"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-DNBGJLP2FN');
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Konfigurator Półki</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <style>
    /* --- Style dla animacji generowania kodów --- */
    #codesSection.visible {
        opacity: 1;
        transform: translateY(0);
        transition: opacity 0.5s ease-out, transform 0.5s ease-out;
    }

    #typingCursor {
        position: absolute;
        top: 9px;
        left: 9px;
        width: 2px;
        height: 1.5em; /* Wysokość dopasowana do wielkości fontu w textarea */
        background-color: #1f2937;
        opacity: 0;
        animation: blink 1s steps(1) infinite;
    }

    @keyframes blink {
        50% {
            opacity: 1;
        }
    }

    /* --- Style dla PŁYWAJĄCEGO przycisku "Zobacz kody" --- */
    #scrollToCodesBtn {
        position: absolute;
        bottom: 7rem; /* Pozycjonowanie nad stopką modala */
        right: 1.5rem;
        z-index: 1055; /* Wyżej niż treść modala */
        width: 48px;
        height: 48px;
        border-radius: 9999px;
        background-color: #16a34a;
        color: white;
        display: none; /* Domyślnie ukryty */
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        border: 2px solid rgba(255, 255, 255, 0.5);
        opacity: 0;
        transform: scale(0.8);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    #scrollToCodesBtn.visible {
        display: flex;
        opacity: 1;
        transform: scale(1);
    }
    
    #scrollToCodesBtn:hover {
        background-color: #15803d;
        transform: scale(1.05);
    }

    #scrollToCodesBtn svg {
        width: 28px;
        height: 28px;
    }
    
    @keyframes pulse-glow {
        0% {
            box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(22, 163, 74, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(22, 163, 74, 0);
        }
    }
    .pulse-glow-animation {
        animation: pulse-glow 2s infinite ease-out;
    }
        
    /* ---- NOWE STYLE DLA SPEKTAKULARNEJ WSKAZÓWKI W GALERII ---- */
    
    /* Kontener planszy informacyjnej */
    .gallery-intro-tile {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #f0fdf4; /* Jasnozielone tło */
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    z-index: 5;
    opacity: 1;
    transition: opacity 0.5s ease-in-out;
    overflow: hidden; /* Ukrywa części animacji wychodzące poza ramkę */
}

    /* Klasa dodawana, gdy cała plansza ma zniknąć */
    .gallery-intro-tile.fade-out {
        opacity: 0;
    }

    /* Styl tekstu wewnątrz planszy */
    .gallery-intro-tile p {
        color: #065f46;
        text-align: center;
        font-size: 1.05em;
        line-height: 1.4;
        margin: 0;
        font-weight: 500;
        opacity: 0; /* Domyślnie niewidoczny */
        transform: translateY(10px); /* Lekko przesunięty w dół */
        animation: fadeInText 0.8s ease-out 0.5s forwards; /* Animacja tekstu z opóźnieniem */
    }

    .gallery-intro-tile strong {
        color: #05422d;
        font-weight: 700;
    }

    /* Pseudoelementy tworzące animowany "wężyk" */
    .gallery-intro-tile::before,
    .gallery-intro-tile::after {
        content: '';
        position: absolute;
        background: linear-gradient(90deg, #16A34A, #34D399, #a7f3d0); /* Gradient "wężyka" */
    }

    /* Definicja animacji dla wężyka */
    .gallery-intro-tile.is-animating::before {
        height: 2px; /* Grubość wężyka */
        animation: snake-progress-top 3.5s linear forwards;
    }
    .gallery-intro-tile.is-animating::after {
        width: 2px; /* Grubość wężyka */
        animation: snake-progress-right 3.5s linear forwards;
    }

    /* Animacja tekstu (pojawianie się) */
    @keyframes fadeInText {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Animacja paska postępu - część górna i dolna */
    @keyframes snake-progress-top {
        0% { top: 0; left: 0; width: 0; }
        25% { top: 0; left: 0; width: 100%; }
        25.01% { top: 100%; left: 0; width: 100%; } /* Skok na dół */
        50% { top: 100%; left: 0; width: 100%; }
        50.01% { top: 100%; left: 100%; width: 0; } /* Zwijanie się na dole */
        75% { top: 100%; left: 100%; width: 0; }
        100% { top: 100%; left: 100%; width: 0; }
    }

    /* Animacja paska postępu - część prawa i lewa */
    @keyframes snake-progress-right {
        0% { top: 0; left: 0; height: 0; }
        25% { top: 0; left: 0; height: 0; }
        25.01% { top: 0; left: 100%; height: 0; } /* Start z prawego górnego rogu */
        50% { top: 0; left: 100%; height: 100%; }
        50.01% { top: 0; left: 0; height: 100%; } /* Skok w lewo */
        75% { top: 100%; left: 0; height: 0; } /* Zwijanie się od dołu */
        100% { top: 100%; left: 0; height: 0; }
    }
    
    /* ---- KONIEC NOWYCH STYLÓW ---- */
    
    /* --- Animacja dodawania do koszyka --- */
    .shelf-to-cart-animation {
        position: fixed;
        z-index: 2000;
        transition: transform 1s cubic-bezier(0.4, 0, 0.8, 0.4), opacity 1s ease-in, width 1s ease-in-out, height 1s ease-in-out;
        pointer-events: none;
        border-radius: 0.5rem;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    
    /* --- Style dla przycisków +/- w koszyku --- */
    .quantity-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .quantity-btn {
        background-color: #f3f4f6;
        border: 1px solid #e5e7eb;
        border-radius: 9999px;
        width: 26px;
        height: 26px;
        font-weight: 600;
        color: #4b5563;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.15s ease, color 0.15s ease, transform 0.1s ease;
    }
    .quantity-btn:hover {
        background-color: #e5e7eb;
        color: #1f2937;
    }
    .quantity-btn:active {
        transform: scale(0.9);
    }
    .quantity-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .quantity-display {
        font-weight: 600;
        font-size: 1rem;
        min-width: 28px;
        text-align: center;
        color: #1f2937;
    }

    /* Style niestandardowe */
    ul.list-none { list-style-type: none; padding-left: 0; }

    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

    .instruction-list li { display: flex; align-items: start; margin-bottom: 0.75rem; }
    .instruction-list li svg { width: 1.25rem; height: 1.25rem; margin-right: 0.75rem; flex-shrink: 0; margin-top: 0.125rem; color: #16A34A; }

    /* ---- Style dla wysuwanego panelu 3D (Mobile) ---- */
    @media (max-width: 767px) {
        #shelfContainer {
            position: fixed !important; bottom: 0; left: 0; right: 0;
            width: 100% !important; height: 45vh !important; max-width: none !important;
            background-color: #ffffff !important;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15) !important;
            border-top-left-radius: 1rem !important; border-top-right-radius: 1rem !important;
            z-index: 1000 !important;
            transform: translateY(100%); visibility: hidden !important;
            transition: transform 0.35s ease-in-out, visibility 0s linear 0.35s !important;
            padding: 0 !important; display: flex !important; flex-direction: column !important;
            overflow: hidden !important; margin-bottom: 0 !important;
        }
        #shelfContainer.active {
            transform: translateY(0) !important; visibility: visible !important;
            transition: transform 0.35s ease-in-out, visibility 0s linear 0s !important;
        }
         #threeJsCanvasWrapper {
             width: 100% !important; height: 100% !important; min-height: initial !important;
             border-radius: 0 !important; background-color: #F5F5F4 !important;
             cursor: grab !important; flex-grow: 1 !important; margin: 0 !important;
             padding: 0 !important; position: relative !important; overflow: hidden !important;
         }
         #threeJsCanvasWrapper:active { cursor: grabbing !important; }
         #modalOverlay { display: none !important; }

        /* ---- STYLE DLA PRZYCISKU ZWIJANIA ---- */
         #collapse3dPanelButton {
            display: flex !important; align-items: center; justify-content: center;
            position: absolute !important; top: 0.5rem; right: 0.5rem; z-index: 1002 !important;
            width: 2.5rem; height: 2.5rem; background-color: rgba(255, 255, 255, 0.7) !important;
            backdrop-filter: blur(4px) !important; border-radius: 9999px !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important; cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
         }
         #collapse3dPanelButton:hover { background-color: rgba(255, 255, 255, 0.9) !important; }
         #collapse3dPanelButton:active { transform: scale(0.95); }
         #collapse3dPanelButton svg { width: 1.5rem; height: 1.5rem; color: #374151; }

        /* ---- Style dla ikon nawigacyjnych (lewy dolny róg) ---- */
        #shelfContainer.active #mobilePanelIcons {
            display: flex !important; flex-direction: column; position: absolute !important;
            left: 0.5rem; bottom: 0.5rem;
            z-index: 1001 !important; gap: 0.5rem;
        }
        #mobilePanelIcons button {
           display: flex; flex-direction: column; align-items: center; justify-content: center;
           width: 65px; height: 65px; padding: 0.5rem; background-color: rgba(255, 255, 255, 0.8);
           backdrop-filter: blur(6px); border: 1px solid rgba(255, 255, 255, 0.3);
           border-radius: 0.875rem; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0,0,0,0.08);
           cursor: pointer; transition: background-color 0.2s ease-in-out, transform 0.15s ease-in-out, box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
           color: #374151; overflow: hidden;
        }
        #mobilePanelIcons button:hover { background-color: rgba(255, 255, 255, 0.95); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.12), 0 2px 5px rgba(0,0,0,0.1); transform: translateY(-2px); color: #16A34A; }
        #mobilePanelIcons button:active { transform: translateY(0px) scale(0.96); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); background-color: rgba(240, 240, 240, 0.85); }
        #mobilePanelIcons button svg { width: 1.75rem; height: 1.75rem; margin-bottom: 0.15rem; transition: color 0.2s ease-in-out, transform 0.15s ease-in-out; color: #4b5563; }
        #mobilePanelIcons button:hover svg { color: #16A34A; transform: scale(1.); }
        #mobilePanelIcons button span { font-size: 0.6rem; line-height: 0.75rem; font-weight: 600; text-align: center; display: block; transition: color 0.2s ease-in-out; }
        #mobilePanelIcons button.mobile-icon-active { background-color: rgba(220, 252, 231, 0.9); border-color: rgba(22, 163, 74, 0.4); color: #15803d; box-shadow: 0 4px 12px rgba(22, 163, 74, 0.15), 0 2px 4px rgba(0,0,0,0.08); }
        #mobilePanelIcons button.mobile-icon-active svg { color: #15803d; }
        
        .mobile-icon-details {
            display: flex;
            gap: 4px;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            line-height: 0.75rem;
            font-weight: 500;
            color: #4b5563;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            padding: 0 2px;
            height: 12px;
        }
        
        .mobile-color-swatch {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 3px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }

        .mobile-icon-prompt {
            color: #ef4444;
            font-weight: 600;
            font-style: italic;
        }

        /* Ikony akcji (cena, skrót do podsumowania) */
        #mobile3dActionsContainer {
            display: none;
            flex-direction: row;
            align-items: center;
            gap: 0.5rem;
            position: absolute;
            top: 0.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1002;
        }

        .mobile-3d-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 42px;
            padding: 0 0.75rem;
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 9999px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12), 0 1px 3px rgba(0,0,0,0.08);
            transition: all 0.2s ease-in-out;
            color: #374151;
            cursor: pointer;
        }
        
        #mobilePriceIcon {
            gap: 0.3rem;
            cursor: default;
        }
        
        #mobilePriceIcon svg {
            width: 1.1rem;
            height: 1.1rem;
            color: #be185d;
        }
        
        #mobilePriceValue {
            font-size: 1rem;
            font-weight: 700;
            color: #be185d;
            line-height: 1;
        }

        /* Zmieniony przycisk koszyka na skrót do podsumowania */
        #mobileGoToSummaryBtn {
            padding: 0;
            width: 42px;
        }

        #mobileGoToSummaryBtn svg {
            width: 1.5rem;
            height: 1.5rem;
            color: #374151;
        }

        /* NOWE STYLE DLA INFORMACJI O PÓŁKACH NA MOBILE */
        #mobileShelfInfo {
    position: absolute;
    bottom: 0.75rem;
    left: 50%; /* <-- ZMIANA: Przesuń lewą krawędź na środek */
    transform: translateX(-50%); /* <-- ZMIANA: Cofnij o połowę szerokości elementu */
    z-index: 1001;
    font-size: 0.65rem;
    color: #4b5563;
    text-align: center; /* <-- ZMIANA: Wyśrodkuj tekst wewnątrz */
    line-height: 1.3;
    display: none;
    pointer-events: none;
}

        #mobileShelfInfo p {
            margin: 0;
        }
    }
    
    /* Panel przegródek i montażu (NOWA WERSJA) */
    #mugShelfDividerIconsContainer {
        display: none;
        flex-direction: column;
        align-items: stretch;
        position: absolute !important;
        right: 0.5rem;
        top: 59%;
        transform: translateY(-50%);
        z-index: 1001;
        gap: 0;
        padding: 0.5rem;
        background-color: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 0.75rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    #mugShelfDividerIconsContainer.visible { display: flex !important; }

    #dividerIconGroup { 
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.4rem;
    }
    
    .divider-control-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.15rem;
    }

    .divider-label {
        font-size: 0.6rem;
        font-weight: 600;
        color: #4b5563;
        pointer-events: none;
        line-height: 1;
    }

    .mount-divider {
        width: 80%;
        height: 1px;
        background-color: #d1d5db;
        margin: 0.4rem auto;
    }
    
    #mugShelfDividerIconsContainer .mobile-divider-icon-small {
       display: flex; align-items: center; justify-content: center;
       width: 36px; height: 36px;
       padding: 0.2rem; background-color: rgba(243, 244, 246, 0.9);
       border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
       cursor: pointer; transition: all 0.15s ease-in-out; color: #4B5563;
    }
    #mugShelfDividerIconsContainer .mobile-divider-icon-small:hover { background-color: #e5e7eb; border-color: #9ca3af; color: #16A34A; transform: scale(1.05); }
    #mugShelfDividerIconsContainer .mobile-divider-icon-small.active-divider-icon { background-color: #16A34A; border-color: #15803d; color: #ffffff; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); transform: scale(1.05); }
    #mugShelfDividerIconsContainer .mobile-divider-icon-small svg { width: 1.25rem; height: 1.25rem; stroke-width: 1.75; }

    /* Nowe style dla przycisków tekstowych montażu */
    #mountIconGroup {
        display: flex;
        flex-direction: column;
        align-items: stretch; /* Przyciski rozciągną się na całą szerokość */
        gap: 0.3rem;
    }
    .mount-text-button {
        font-size: 0.75rem;
        padding: 0.375rem 0.5rem;
        border-radius: 0.375rem;
        text-align: center;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s ease-in-out;
        border: 1px solid #d1d5db;
        line-height: 1.2;
        background-color: rgba(243, 244, 246, 0.9);
        color: #374151;
    }
    .mount-text-button:hover {
        background-color: #e5e7eb;
        border-color: #9ca3af;
        color: #16A34A;
    }
    /* Aktywny stan przełączany przez JS */
    .mount-text-button.active-mount-strip {
        background-color: #16A34A;
        color: #ffffff;
        border-color: #15803d;
        transform: scale(1.02);
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
    }

    /* Stary panel montażu jest teraz ukryty na stałe */
    #mobileMugShelfMountPanel {
        display: none !important;
    }

    /* Nowy styl dla znikającej chmurki z podpowiedzią */
    #dividerTooltip {
        position: absolute;
        right: calc(100% + 10px); /* Na lewo od panelu przegródek */
        top: 5%;
        transform: translateY(-50%);
        background-color: #374151;
        color: white;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        line-height: 1.3;
        width: 150px;
        text-align: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        pointer-events: none;
    }
    #dividerTooltip.visible {
        opacity: 1;
        visibility: visible;
    }
    #dividerTooltip::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 100%;
        transform: translateY(-50%);
        border-width: 6px;
        border-style: solid;
        border-color: transparent transparent transparent #374151;
    }

    /* Oryginalne style desktopowe */
    @media (min-width: 768px) {
         #shelfContainer {
             position: static; bottom: auto; left: auto; right: auto; width: 100%;
             height: 500px; max-width: 500px; background-color: #F5F5F4; box-shadow: none;
             border-radius: 0.5rem; z-index: auto; transform: none; visibility: visible;
             transition: none; padding: 0; display: block; flex-direction: initial;
             overflow: hidden; margin-bottom: 0.5rem; cursor: grab;
         }
#collapse3dPanelButton { display: none !important; }
         #mobilePanelIcons { display: none !important; }
         #mobile3dActionsContainer { display: none !important; }
         
         #mobileShelfInfo { display: none !important; }

         #threeJsCanvasWrapper { width: 100%; height: 100%; min-height: initial; border-radius: inherit; background-color: transparent; cursor: inherit; flex-grow: initial; position: static; overflow: hidden; }
         #threeJsCanvasWrapper:active { cursor: grabbing; }
         #modalOverlay { display: none !important; }
         /* Ukryj pływający przycisk na desktopie */
         #scrollToCodesBtn {
             display: none !important;
         }
    }

    /* Reszta stylów podstawowych - bez zmian */
    input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #D6D3D1; border-radius: 5px; outline: none; opacity: 0.7; transition: opacity .2s; }
    input[type=range]:hover { opacity: 1; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #16A34A; border-radius: 50%; cursor: pointer; transition: background-color 0.15s ease-in-out; }
    input[type=range]::-webkit-slider-thumb:active { background: #15803d; }
    input[type=range]::-moz-range-thumb { width: 20px; height: 20px; background: #16A34A; border-radius: 50%; cursor: pointer; border: none; transition: background-color 0.15s ease-in-out; }
    input[type=range]::-moz-range-thumb:active { background: #15803d; }
    .review-fade-enter { opacity: 0; transition: opacity 700ms ease-in-out; }
    .review-fade-enter-active { opacity: 1; }
    details.color-samples-details { margin-top: 1rem; }
    details.color-samples-details > summary { list-style: none; cursor: pointer; padding: 0.5rem 0; display: flex; justify-content: space-between; align-items: center; color: #57534E; font-size: 0.875rem; font-weight: 500; transition: color 0.2s ease; border-top: 1px dashed #E7E5E4; padding-top: 0.75rem; }
    details.color-samples-details > summary::-webkit-details-marker { display: none; }
    details.color-samples-details > summary::marker { display: none; }
    details.color-samples-details > summary:hover { color: #16A34A; }
    details.color-samples-details > summary .summary-chevron { transition: transform 0.2s ease-in-out; color: #A8A29E; }
    details[open].color-samples-details > summary .summary-chevron { transform: rotate(180deg); color: #16A34A; }
    #materialSwiper { width: 100%; height: 250px; margin-top: 0.75rem; border-radius: 0.375rem; background-color: #E7E5E4; position: relative; overflow: hidden; }
    @media (min-width: 768px) { #materialSwiper { height: 250px; } }
    #materialSwiper .swiper-slide { text-align: center; font-size: 18px; background: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; }
    #materialSwiper .swiper-slide img { display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 0.5rem;}
    #materialSwiper .material-name { position: absolute; bottom: 0; left: 0; width: 100%; background-color: rgba(0, 0, 0, 0.6); color: white; padding: 0.375rem 0.75rem; font-size: 0.875rem; text-align: center; }
    .material-swiper-button-prev, .material-swiper-button-next { position: absolute; top: 50%; transform: translateY(-50%); z-index: 10; cursor: pointer; background-color: rgba(255, 255, 255, 0.7); border-radius: 50%; width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center; color: #44403C; transition: background-color 0.2s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.material-swiper-button-prev:hover, .material-swiper-button-next:hover { background-color: rgba(255, 255, 255, 0.9); color: #16A34A; }
    .material-swiper-button-prev { left: 10px; } .material-swiper-button-next { right: 10px; }
    .material-swiper-button-prev::after, .material-swiper-button-next::after { font-family: 'swiper-icons'; font-size: 1rem; font-weight: bold; }
    .material-swiper-button-prev.swiper-button-disabled, .material-swiper-button-next.swiper-button-disabled { opacity: 0.35; cursor: auto; pointer-events: none; }
    details:not(.color-samples-details) summary { list-style: none; cursor: pointer; }
    details:not(.color-samples-details) summary::-webkit-details-marker { display: none; }
    details:not(.color-samples-details) summary::marker { display: none; }
    details:not(.color-samples-details) summary .marker { transition: transform 0.2s ease-in-out; margin-left: auto; }
    details[open]:not(.color-samples-details) summary .marker { transform: rotate(180deg); }
    details:not(.color-samples-details) summary { position: relative; }
    details:not(.color-samples-details) summary::before { content: ''; display:none; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
    select.custom-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-position: right 0.75rem center; background-repeat: no-repeat; background-size: 1.25em 1.25em; padding-right: 2.75rem; padding-top: 0.5rem; padding-bottom: 0.5rem; padding-left: 0.75rem; border-width: 1px; border-color: #A8A29E; border-radius: 0.375rem; background-color: #FFFFFF; transition: all 150ms ease-in-out; width: 100%; }
    select.custom-select:focus { outline: 2px solid transparent; outline-offset: 2px; --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color); --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color); box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000); --tw-ring-offset-width: 1px; --tw-ring-color: #16A34A; border-color: #16A34A; }
    select.custom-select:disabled { background-color: #F5F5F4; color: #A8A29E; cursor: not-allowed; border-color: #E7E5E4; background-image: none; }
    .color-swatch-display { display: inline-block; width: 1.25rem; height: 1.25rem; border-radius: 0.25rem; margin-left: 0.5rem; vertical-align: middle; background-color: #E5E7EB; border: 1px solid #D1D5DB; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05); transition: background-color 0.2s ease-in-out; flex-shrink: 0; }
    .color-swatch-display.swatch-white-display { border-color: #9CA3AF; }
    
    /* Pozostałe animacje i style... */
    @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }
    .icon-bounce { animation: bounce 1s infinite; }
    @keyframes bg-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.85; } }
    .animate-bg-pulse { animation: bg-pulse 3s infinite ease-in-out; }
    @keyframes icon-rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .animate-icon-rotate { animation: icon-rotate 15s linear infinite; }
    @keyframes gallery-spin { to { transform: rotate(360deg); } }
    @keyframes pulse-bg-effect {
        0% { background-color: rgba(22, 163, 74, 0); transform: scale(1); }
        50% { background-color: rgba(22, 163, 74, 0.1); transform: scale(1.05); }
        100% { background-color: rgba(22, 163, 74, 0); transform: scale(1); }
    }
    .animate-pulse-bg {
        animation: pulse-bg-effect 1.2s ease-in-out 2;
    }
    @keyframes subtle-bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(3px); }
    }
    .animate-subtle-bounce {
        animation: subtle-bounce 2.5s ease-in-out infinite;
    }

    #mugShelfDividersOptions label, #mugShelfMountOptions label { display: block; margin-bottom: 0.5rem; cursor: pointer; font-size: 0.875rem; color: #374151; }
    #mugShelfDividersOptions input[type="checkbox"], #mugShelfMountOptions input[type="radio"] { margin-right: 0.5rem; cursor: pointer; border-color: #D1D5DB; color: #16A34A; transition: all 0.15s ease-in-out; }
    #mugShelfDividersOptions input[type="checkbox"] { border-radius: 0.25rem; }
    #mugShelfMountOptions input[type="radio"] { border-radius: 9999px; }
    #mugShelfDividersOptions input[type="checkbox"]:focus, #mugShelfMountOptions input[type="radio"]:focus { ring: 2px; ring-offset-0; ring-green-500; }
    .mug-options-header { text-md font-semibold mb-2 text-stone-700; }
    #mugShelfMountOptions { display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #e5e7eb; }
    #mugShelfDividersOptions { display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #e5e7eb; }
    #desktopDividerDimensionsInfo { margin-top: 0.25rem; font-size: 0.75rem; color: #57534E; }

    #imageLightbox.hidden { display: none; }
    
    .image-actions-bar {
        position: absolute;
        top: 8px;
        right: 8px;
        z-index: 10;
        display: flex;
        gap: 6px;
    }
    .image-actions-bar .action-icon-btn {
        background-color: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 50%; 
        padding: 6px;
        cursor: pointer;
        color: #374151; 
        line-height: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s ease, background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }
    .image-actions-bar .action-icon-btn:hover {
        color: #16a34a;
        background-color: rgba(255, 255, 255, 0.9);
        transform: scale(1.1) translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .image-actions-bar .action-icon-btn:active {
        transform: scale(1);
        transition-duration: 0.1s;
    }
    .image-actions-bar .action-icon-btn svg {
        width: 22px;
        height: 22px;
        display: block;
    }
    .image-actions-bar .action-icon-btn.gallery-configure-btn svg {
        animation: gallery-spin 2.5s linear infinite;
    }

    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 1050; opacity: 0; transition: opacity 0.3s ease-in-out; }
    .modal-overlay.visible { display: flex; opacity: 1; }
    .modal { position: relative; background-color: #ffffff; border-radius: 0.75rem; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); width: 90%; max-width: 520px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; transform: translateY(20px) scale(0.95); opacity: 0; transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s ease-in-out; }
    .modal-overlay.visible .modal { transform: translateY(0) scale(1); opacity: 1; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; background-color: #f9fafb; }
    .modal-title { font-size: 1.125rem; font-weight: 600; color: #1f2937; }
    .modal-close-button { background: none; border: none; font-size: 1.75rem; line-height: 1; color: #9ca3af; cursor: pointer; padding: 0.25rem; transition: color 0.2s ease, transform 0.1s ease; }
    .modal-close-button:hover { color: #374151; }
    .modal-close-button:active { transform: scale(0.9); }
    .modal-body { padding: 1.25rem 1.5rem; overflow-y: auto; flex-grow: 1; color: #4b5563; }
    .modal-body p, .modal-body li { line-height: 1.6; margin-bottom: 0.75rem; }
    .modal-body strong { color: #374151; }
    .modal-footer { padding: 1rem 1.5rem; background-color: #f9fafb; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; gap: 0.75rem; }
    #orderDetailsModal .modal-body h4 { font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; color: #111827; }
    
    #cartSummaryModal .modal-body ol { padding-left: 1.25rem; }
    #cartSummaryModal .modal-body li { margin-bottom: 0.5rem; }
    #cartSummaryItemsContainer {
        max-height: 45vh;
        overflow-y: auto;
        margin: -0.75rem;
        padding: 0.75rem;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
    }
    
    .summary-snapshot-container {
        flex-shrink: 0;
        width: 96px;
        height: 96px;
        background-color: #f5f5f4;
        border-radius: 0.375rem;
        border: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }
    
    .summary-snapshot-container img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    @media (max-width: 640px) {
        .modal { width: 95%; border-radius: 0.5rem; max-width: 95%;}
        .modal-header { padding: 0.75rem 1rem; }
        .modal-title { font-size: 1rem; }
        .modal-close-button { font-size: 1.5rem; }
        .modal-body { padding: 1rem; font-size: 0.9rem; }
        .modal-footer { padding: 0.75rem 1rem; flex-direction: column-reverse; align-items: stretch; }
        .modal-footer > div { display: flex; gap: 0.5rem; }
        .modal-footer > div:first-child { justify-content: center; margin-bottom: 0.5rem;}
        .modal-footer > div button { flex-grow: 1; }
    }

    #viewOrderSection label { display: block; font-size: 0.875rem; font-weight: 500; color: #57534e; margin-bottom: 0.25rem; }
    #viewOrderSection input[type="text"] { width: 100%; border-radius: 0.375rem; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
    #viewOrderSection input[type="text"]:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 1px #10b981; }
    #viewOrderSection input[type="text"]:placeholder-shown { font-style: italic; }
    #tabbedGalleryContainer { background-color: #ffffff; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1rem; margin-bottom: 1.5rem; border: 1px solid #e5e7eb; }
    .gallery-tabs { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.75rem; }
    .gallery-tab { padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 600; color: #57534e; background-color: #f5f5f4; border: 1px solid #e5e7eb; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; white-space: nowrap; }
    .gallery-tab:hover { background-color: #e7e5e4; color: #44403c; }
    .gallery-tab.active { background-color: #16A34A; color: #ffffff; border-color: #15803d; }
    
    .gallery-content-wrapper { position: relative; width: 100%; overflow: hidden; min-height: 200px; }
    .gallery-image-area { overflow: hidden; padding: 12px 2px; position: relative; margin: 0; }
    .gallery-grid { display: flex; }
    .gallery-tile {
        width: 260px;
        flex-shrink: 0;
        box-sizing: border-box;
        transition: transform 0.3s, opacity 0.3s;
    }
     @media (max-width: 768px) { .gallery-tile { width: 280px; } }
     @media (max-width: 480px) { .gallery-tile { width: 240px; } }

    .gallery-tile.gallery-tile--active {
         transform: scale(1.02);
    }
    .gallery-image-container { 
        position: relative; width: 100%; height: 180px; border-radius: 6px; overflow: hidden;
        background: #fff; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.08);
        transition: transform 0.3s, box-shadow 0.3s;
        cursor: grab;
    }
    .gallery-image-container:active { cursor: grabbing; }

    .gallery-image-container img { 
        width: 100%; 
        height: 100%; 
        object-fit: contain;
        background: #fff; 
        transition: transform 0.35s; 
    }
    .gallery-tile:hover .gallery-image-container img { transform: scale(1.05); }

    .config-btn { display: none !important; }

    .info-ticker-wrap {
        position: absolute;
        bottom: 12px;
        left: 0;
        width: 100%;
        background-color: #ffffff;
        overflow: hidden;
        padding: 5px 0;
        box-sizing: border-box;
        display: flex;
        align-items: center;
        z-index: 5;
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.04);
    }
    .info-ticker-content {
        display: inline-block;
        white-space: nowrap;
        animation: ticker-scroll 90s linear infinite;
        padding-left: 100%;
    }
    .info-ticker-content span {
        display: inline-block;
        color: #374151;
        font-weight: 400;
        font-size: 14px;
        padding: 0 1.5rem;
        vertical-align: middle;
    }
    .info-ticker-wrap:hover .info-ticker-content {
        animation-play-state: paused;
    }
    @keyframes ticker-scroll {
        0% { transform: translateX(0); }
        100% { transform: translateX(-100%); }
    }

    .gallery-caption {
        margin-top: 8px; font-size: .8em; font-weight: 500; color: #57534E;
        text-align: center; width: 100%;
        opacity: 0.7; transition: opacity 0.3s ease;
    }
    .gallery-tile:hover .gallery-caption { opacity: 1; }
    
    .gallery-arrow { position: absolute; top: 45%; transform: translateY(-50%); width: 40px; height: 40px; font-size: 20px; background: #fff; border: 1px solid #e0e0e0; border-radius: 50%; box-shadow: 0 2px 6px rgb(0 0 0 / .12); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background .2s, box-shadow .2s, opacity .3s, transform 0.2s ease-out; z-index: 10; color: #374151; }
    .gallery-content-wrapper:hover .gallery-arrow { opacity: 1; pointer-events: auto; }
    .gallery-arrow:hover { background: #f0f0f0; box-shadow: 0 3px 9px rgb(0 0 0 /.18); transform: translateY(-50%) scale(1.05); color: #16A34A; }
    .gallery-arrow:active { transform: translateY(-50%) scale(0.95); background: #e7e7e7;}
    .gallery-prev-arrow { left: 12px; } .gallery-next-arrow { right: 12px; }
    .gallery-arrow.swiper-button-disabled { opacity: 0.2; cursor: not-allowed; pointer-events: none; }


    #stickyFooterBar { transform: translateY(0); transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; padding: 0.5rem 0.25rem; height: 60px; z-index: 990; }
    #stickyFooterBar > * { background: none; border: none; padding: 0; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-size: 0.75rem; line-height: 1rem; text-align: center; flex-grow: 1; flex-basis: 0; height: 100%; transition: background-color 0.15s ease-in-out; min-width: 0; cursor: pointer; }
    #stickyFooterBar > *:hover, #stickyFooterBar > *:focus { background-color: rgba(255, 255, 255, 0.1); outline: none; border-radius: 0.25rem; }
    #stickyFooterBar button svg { width: 1.5rem; height: 1.5rem; margin-bottom: 0.125rem; pointer-events: none; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .animate-spin-slow { animation: spin 4s linear infinite; }
    @keyframes section-highlight-anim { 0% { background-color: rgba(22, 163, 74, 0) !important; } 50% { background-color: rgba(22, 163, 74, 0.15) !important; } 100% { background-color: rgba(22, 163, 74, 0) !important; } }
    .section-highlight-flash { animation: section-highlight-anim 0.75s ease-in-out; }
    .section-highlight-persistent { background-color: rgba(22, 163, 74, 0.08) !important; transition: background-color 0.3s ease-out; border-radius: 0.5rem; }

    .order-summary-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    #desktopCartContainer {
        position: relative;
    }

    .cart-badge {
        position: absolute;
        top: -5px;
        right: -8px;
        background-color: #ef4444;
        color: white;
        border-radius: 9999px;
        width: 1.25rem;
        height: 1.25rem;
        font-size: 0.75rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
        border: 2px solid #ffffff;
        transform: scale(1);
        transition: transform 0.2s ease;
    }
    #desktopCartContainer:hover .cart-badge {
        transform: scale(1.1);
    }
    
    #cartPanelOverlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1040;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease-in-out, visibility 0s linear 0.3s;
    }
    #cartPanelOverlay.visible {
        opacity: 1;
        visibility: visible;
        transition: opacity 0.3s ease-in-out, visibility 0s linear 0s;
    }

    #cartPanel {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        max-width: 400px;
        background-color: #ffffff;
        box-shadow: -5px 0 15px rgba(0,0,0,0.1);
        z-index: 1041;
        transform: translateX(100%);
        transition: transform 0.35s cubic-bezier(0.25, 0.8, 0.25, 1);
        display: flex;
        flex-direction: column;
    }
    #cartPanel.visible {
        transform: translateX(0);
    }
    @media (max-width: 480px) {
        #cartPanel {
            max-width: 90%;
        }
    }
    #cartPanelHeader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        background-color: #f9fafb;
    }
    #cartPanelTitle {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
    }
    #cartPanelCloseBtn {
        background: none; border: none; font-size: 1.75rem; line-height: 1; 
        color: #9ca3af; cursor: pointer; padding: 0.25rem; transition: color 0.2s ease;
    }
    #cartPanelCloseBtn:hover { color: #374151; }
    
    #cartItemsContainer {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1rem;
    }
    #cartEmptyMessage {
        text-align: center;
        color: #6b7280;
        padding-top: 4rem;
    }
    #cartEmptyMessage svg {
        margin: 0 auto 1rem;
    }

    #cartPanelFooter {
        padding: 1.5rem;
        border-top: 1px solid #e5e7eb;
        background-color: #f9fafb;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }

    #cartCheckoutButton {
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        font-weight: 600;
        color: white;
        background-color: #16A34A;
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: background-color 0.2s ease, transform 0.1s ease;
        text-align: center;
        display: block;
        margin-top: 1rem;
    }
    #cartCheckoutButton:hover {
        background-color: #15803d;
    }
    #cartCheckoutButton:active {
        transform: scale(0.98);
    }
    #cartCheckoutButton:disabled {
        background-color: #d1d5db;
        cursor: not-allowed;
        transform: scale(1);
    }

</style>
</head>
<body class="flex flex-col justify-center items-center min-h-screen bg-stone-100 font-sans text-stone-800 pb-20 md:pb-0">

    <div id="cartPanelOverlay"></div>
    <div id="cartPanel">
<div id="cartPanelHeader">
            <h2 id="cartPanelTitle">Twój koszyk</h2>
            <button id="cartPanelCloseBtn" aria-label="Zamknij koszyk">&times;</button>
        </div>
        <div id="cartDiscountReminder" class="p-3 bg-emerald-50 border-b border-emerald-200 text-center text-sm text-emerald-800" style="display: none;">
            </div>
        <div id="cartItemsContainer">
            <div id="cartEmptyMessage">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-stone-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                </svg>
                <p>Twój koszyk jest pusty.</p>
                <p class="text-sm mt-1">Dodaj produkty z konfiguratora.</p>
            </div>
        </div>
        <div id="cartPanelFooter">
            <div id="cartTotalContainer" class="space-y-1 text-sm">
                 <div class="flex justify-between" id="cartSubtotalLine" style="display: none;">
                    <span>Suma częściowa:</span>
                    <span id="cartSubtotalPrice"></span>
                 </div>
                 <div class="flex justify-between text-green-600 font-semibold" id="cartDiscountLine" style="display: none;">
                    <span>Rabat (-25%):</span>
                    <span id="cartDiscountAmount"></span>
                 </div>
                 <div class="flex justify-between items-baseline font-bold text-base border-t border-stone-200 pt-1 mt-1">
                     <span>Do zapłaty:</span>
                     <span id="cartTotalPrice">0,00 zł</span>
                 </div>
            </div>
            <button id="cartCheckoutButton" disabled>
                Przejdź do podsumowania
            </button>
        </div>
    </div>

    <div id="imageLightbox" class="fixed inset-0 bg-black bg-opacity-85 flex items-center justify-center z-[1060] hidden p-4 transition-opacity duration-300 ease-in-out">
        <div class="relative">
            <img id="lightboxImage" src="" alt="Powiększone zdjęcie" class="max-w-[95vw] max-h-[90vh] object-contain rounded-md shadow-2xl">
            <button id="lightboxClose" aria-label="Zamknij powiększenie" class="absolute -top-2 -right-2 md:top-2 md:right-2 text-white bg-stone-800 bg-opacity-70 hover:bg-opacity-100 rounded-full p-1.5 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>
    <div id="orderDetailsModalOverlay" class="modal-overlay"> <div id="orderDetailsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle"> <div class="modal-header"> <h3 id="modalTitle" class="modal-title">Szczegóły Zamówienia</h3> <button class="modal-close-button" aria-label="Zamknij">&times;</button> </div> <div class="modal-body"> <h4>Kod Zamówienia:</h4> <p><strong id="modalOrderCode">Ładowanie...</strong></p> <h4>Podsumowanie:</h4> <p id="modalOrderSummary">Tutaj pojawią się szczegóły zamówienia po implementacji logiki...</p> </div> </div> </div>
    
    <div id="cartSummaryModalOverlay" class="modal-overlay">
        <div id="cartSummaryModal" class="modal !max-w-2xl" role="dialog" aria-modal="true" aria-labelledby="cartSummaryModalTitle">
            <div class="modal-header">
                <h3 id="cartSummaryModalTitle" class="modal-title">Podsumowanie Twojego zamówienia</h3>
                <button id="cartSummaryModalCloseBtnTop" class="modal-close-button" aria-label="Zamknij">&times;</button>
            </div>
            <div class="modal-body">
                <div id="cartSummaryItemsContainer" class="space-y-4">
                    </div>
                <div class="mt-4 pt-4">
                     <div id="cartSummaryTotalContainer" class="space-y-2 mb-4">
                         <div class="flex justify-between text-base" id="cartSummarySubtotalLine" style="display: none;">
                            <span>Suma częściowa:</span>
                            <span id="cartSummarySubtotalPrice"></span>
                         </div>
                         <div class="flex justify-between text-lg text-green-600 font-semibold" id="cartSummaryDiscountLine" style="display: none;">
                            <span>Rabat (-25%):</span>
                            <span id="cartSummaryDiscountAmount"></span>
                         </div>
                         <div class="flex justify-between items-baseline font-bold text-2xl border-t-2 border-stone-300 pt-2 mt-2">
                             <span>Do zapłaty:</span>
                             <span id="cartSummaryTotalPrice" class="text-red-600">0,00 zł</span>
                         </div>
                    </div>

                    <div id="codesSection" class="mt-4 opacity-0" style="transform: translateY(15px);">
                        <label for="cartSummaryAllCodes" class="block text-sm font-medium text-stone-600 mb-1">Kody do wklejenia w "Uwagach do zakupu" na Allegro:</label>
                        <div class="relative">
                            <textarea id="cartSummaryAllCodes" rows="4" class="w-full rounded-md border-stone-300 shadow-sm text-base p-2 bg-stone-50 focus:ring-green-500 focus:border-green-500 font-bold" readonly></textarea>
                            <div id="typingCursor"></div>
                            <button id="copyAllCodesBtn" title="Skopiuj wszystkie kody" class="absolute top-2 right-2 p-1.5 text-stone-500 hover:text-green-600 bg-white rounded-md hover:bg-stone-100 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="mt-4 p-3 bg-amber-50 rounded-md border border-amber-200">
                        <h4 class="font-semibold text-stone-700 mb-2 text-base">Co dalej?</h4>
                        <ol class="list-decimal text-sm text-stone-600 space-y-1.5 pl-5">
                            <li id="cartSummaryInstructionUnits">Na stronie Allegro dodaj do koszyka tyle sztuk, ile wynosi łączna cena Twojego zamówienia.</li>
                            <li>W zakładce "Dostawa i płatność", w polu „Uwagi do zakupu”, wklej skopiowane kody zamówień.</li>
                            <li>Złóż i opłać zamówienie – a my zajmiemy się resztą 😊</li>
                        </ol>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="flex items-center">
                    <button id="downloadCartSummaryBtn" class="px-4 py-2 text-sm font-medium text-stone-700 bg-stone-100 hover:bg-stone-200 rounded-md flex items-center gap-2 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 animate-subtle-bounce" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        <span>Pobierz</span>
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <button id="cartSummaryModalCloseBtnBottom" class="px-4 py-2 text-sm font-medium text-stone-700 bg-stone-200 hover:bg-stone-300 rounded-md">Zamknij</button>
                    <button id="cartSummaryGoToAllegroBtn" class="px-6 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md shadow-sm hover:shadow-lg flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                        <span>Do Allegro</span>
                    </button>
                </div>
            </div>
            <button id="scrollToCodesBtn" title="Zobacz wygenerowane kody">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                </svg>
            </button>
        </div>
    </div>
<div class="w-full max-w-7xl mx-auto px-4 md:px-6 my-6">
        <details class="p-4 bg-emerald-50 border border-emerald-200 rounded-lg md:hidden group"> <summary class="flex justify-between items-center cursor-pointer list-none"> <h2 class="text-lg font-semibold text-emerald-800">Jak zamówić półkę?</h2> <span class="marker transform transition-transform duration-200 rotate-0 group-open:rotate-180"> <svg class="w-5 h-5 text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /> </svg> </span> </summary> <div class="mt-4 pt-4 border-t border-emerald-200"> <ul class="list-none instruction-list text-stone-700 space-y-3 text-sm"> <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 1.905c-.007.379.137.75.431.99l1.005.828c.428.355.53 1.005.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-1.905c.007-.379-.137-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg> <span>Wybierz rodzaj półki, wymiary, kolory i liczbę półek.</span></li>
<li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" /></svg> <span>Dodaj skonfigurowaną półkę do koszyka. Możesz dodać wiele różnych półek.</span></li>
    <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" /></svg> <span>Gdy wszystko gotowe, kliknij w ikonę koszyka, aby zobaczyć podsumowanie.</span></li>
    <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 4.25-3-3m0 0-3 3m3-3v12.75" /></svg> <span>W podsumowaniu strona poda łączną cenę i wszystkie kody zamówień.</span></li>
    <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" /></svg> <span>Kliknij zielony przycisk, aby skopiować kody i przejść na Allegro.</span></li>
    <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" /></svg> <span>Na Allegro zamów tyle sztuk, ile wynosi **łączna cena** (np. 350 zł = 350 szt.).</span></li>
    <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg> <span>W polu „Uwagi do zakupu” wklej **wszystkie** skopiowane kody.</span></li>
    <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Z" /></svg> <span>Opłać zamówienie – my zajmiemy się resztą! 😊</span></li>
</ul> </div> </details> </div>
<div id="tabbedGalleryContainer" class="w-full max-w-7xl mx-auto px-4 md:px-6"> <div class="gallery-tabs" id="galleryTabsContainer"></div> <div class="gallery-content-wrapper"> <button class="gallery-arrow gallery-prev-arrow" aria-label="Poprzednie zdjęcia">&#10094;</button> <div class="gallery-image-area swiper-container" id="galleryImageArea"> <div class="gallery-grid swiper-wrapper" id="galleryGridContainer"></div> </div>
<div class="info-ticker-wrap">
    <div class="info-ticker-content">
        <span>✨ Półeczki wykonane z wysokiej jakości płyty laminowanej • odpornej na wilgoć i zabrudzenia</span>
        <span>✨ Precyzyjne cięcie i klejenie na profesjonalnych maszynach • Brak odprysków i niedoskonałości</span>
        <span>✨ Okleina ABS doskonale przylega do krawędzi • Grubość płyty: 1,8 cm</span>
        <span>✨ Wysyłane gotowe, złożone</span>
    </div>
</div>
<button class="gallery-arrow gallery-next-arrow" aria-label="Następne zdjęcia">&#10095;</button> </div> </div>
<div class="w-full max-w-7xl mx-auto px-4 md:px-6 mb-6">
    <div class="bg-emerald-50 border-2 border-dashed border-emerald-300 rounded-xl p-4 md:p-5 flex items-center space-x-4 shadow-sm">
    <div class="flex-shrink-0">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 md:h-12 md:w-12 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 12 20 22 4 22 4 12"></polyline>
            <rect x="2" y="7" width="20" height="5"></rect>
            <line x1="12" y1="22" x2="12" y2="7"></line>
            <path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path>
            <path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path>
        </svg>
    </div>
    <div>
        <h3 class="font-bold text-emerald-800 text-base md:text-lg">Rabat na drugą półkę!</h3>
        <p class="text-emerald-700 text-sm md:text-base mt-1">Zamów dwie dowolne półki, a na drugą (tańszą) otrzymasz <span class="font-bold">25% rabatu</span>.</p>
    </div>
</div>
</div>
<div id="configuratorSection" class="p-4 md:p-8 bg-white shadow-lg rounded-xl flex flex-col md:flex-row md:space-x-8 w-full max-w-7xl mx-auto mb-6">
        <div class="w-full md:w-1/3 space-y-8 mb-8 md:mb-0 order-1 md:order-1">
             <div id="shelfTypeSectionAnchor" class="p-6 shadow rounded-lg bg-white border border-stone-200 transition-shadow duration-200 hover:shadow-md"> <h2 class="text-lg font-semibold mb-4 flex items-center text-stone-800"> <svg class="h-6 w-6 mr-2 text-green-600 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 1.905c-.007.379.137.75.431.99l1.005.828c.428.355.53 1.005.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-1.905c.007-.379-.137-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg> Rodzaj półki </h2> <select id="shelfType" class="custom-select w-full" onchange="handleShelfTypeChange();"> <option value="">-- Wybierz --</option> <option value="standing">Stojąca na blacie</option> <option value="hanging">Wisząca</option> <option value="mug_shelf">Półka na kubki</option> </select> <div id="shelfTypeOptions" style="display:none; margin-top:1rem;" class="space-y-2"></div> <div id="mugShelfSpecificOptionsContainer" style="display:none;"> <div id="mugShelfMountOptions" class="mt-4 pt-4 border-t border-dashed border-stone-200"></div> <div id="mugShelfDividersOptions" class="mt-4 pt-4 border-t border-dashed border-stone-200"> <h3 class="text-md font-semibold mb-2 text-stone-700">Wstaw przegródki:</h3> <label class="flex items-center space-x-2"><input type="checkbox" id="dividersTop" class="rounded border-stone-300 text-green-600 shadow-sm focus:ring-green-500 focus:ring-offset-0 focus:ring-2" onchange="updatePreview(); updateOrderSummary();"><span>Na górze</span></label> <label class="flex items-center space-x-2 mt-1"><input type="checkbox" id="dividersMiddle" class="rounded border-stone-300 text-green-600 shadow-sm focus:ring-green-500 focus:ring-offset-0 focus:ring-2" onchange="updatePreview(); updateOrderSummary();"><span>Pośrodku</span></label> <label class="flex items-center space-x-2 mt-1"><input type="checkbox" id="dividersBottom" class="rounded border-stone-300 text-green-600 shadow-sm focus:ring-green-500 focus:ring-offset-0 focus:ring-2" onchange="updatePreview(); updateOrderSummary();"><span>Na dole</span></label> </div> </div> </div>
<div id="dimensionSectionAnchor" class="p-6 shadow rounded-lg bg-white border border-stone-200 transition-shadow duration-200 hover:shadow-md"> <h2 class="text-lg font-semibold mb-4 flex items-center text-stone-800"> <svg class="h-6 w-6 mr-2 text-green-600 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12h15m0 0l-6.75-6.75M19.5 12l-6.75 6.75" /> <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v16.5M20.25 3.75v16.5" /> </svg> Wybierz wymiary </h2> <label class="block font-medium text-sm mb-1 text-stone-700">Szerokość:</label> <div id="widthSelectionArea"> <select id="width" class="custom-select w-full" onchange="checkCustomWidth();"> <option value="">-- Wybierz --</option> <option value="34">34 cm</option> <option value="44">44 cm</option> <option value="50">50 cm</option> <option value="60">60 cm</option> <option value="custom">Niestandardowa (35-59 cm)</option> </select> <div class="mt-2"> <input type="range" id="customWidthInput" min="35" max="59" step="1" value="35" style="display:none;" class="mt-2 cursor-pointer" oninput="let val = this.value; if (val === '50') { val = '49'; this.value = val; } document.getElementById('customWidthDisplay').textContent=val+' cm'; handleDimensionChange();"> <div class="flex justify-between items-center mt-1"> <span id="customWidthDisplay" style="display:none; font-weight:bold;" class="text-stone-700"></span> <small id="customWidthFee" style="display:none; font-size:.8rem; color:red;">dopłata +50 zł</small> </div> </div> </div> <label id="heightLabel" class="block font-medium text-sm mt-4 mb-1 text-stone-700">Wysokość:</label> <select id="height" class="custom-select w-full" onchange="handleDimensionChange();"> <option value="">-- Wybierz --</option> <option value="40">40 cm</option> <option value="60">60 cm</option> <option value="80">80 cm</option> </select> <label id="depthLabel" class="block font-medium text-sm mt-4 mb-1 text-stone-700">Głębokość:</label> <select id="depth" class="custom-select w-full" onchange="updatePreview(); updateOrderSummary();"> <option value="">-- Wybierz --</option> </select> </div>
             <div id="colorSectionAnchor" class="p-6 shadow rounded-lg bg-white border border-stone-200 transition-shadow duration-200 hover:shadow-md space-y-4"> <h2 class="text-lg font-semibold mb-4 flex items-center text-stone-800"> <svg class="h-6 w-6 mr-2 text-green-600 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.043-.025a15.994 15.994 0 011.622-3.395m3.42 3.42a15.995 15.995 0 004.764-4.648l3.876-5.814a1.151 1.151 0 00-1.597-1.597L14.146 6.32a15.996 15.996 0 00-4.649 4.763m3.42 3.42a6.776 6.776 0 00-3.42-3.42" /> </svg> Wybierz kolor </h2> <div> <label for="sideColor" class="block font-medium text-sm mb-1 text-stone-700">Kolor boków:</label> <div class="flex items-center"> <select id="sideColor" class="custom-select flex-grow" onchange="updateOrderSummary(); updateSwatchDisplay('sideColor', 'sideColorSwatchDisplay');"> <option value="">-- Wybierz --</option> <option value="#8B5A2B" data-color="#8B5A2B">Dąb Craft Złoty</option> <option value="#FFFFFF" data-color="#FFFFFF">Biały matowy</option> <option value="#000000" data-color="#000000">Czarny matowy</option> </select> <span id="sideColorSwatchDisplay" class="color-swatch-display"></span> </div> </div> <div class="pt-2"> <label id="shelfColorLabel" for="shelfColor" class="block font-medium text-sm mb-1 text-stone-700">Kolor półek i podstaw:</label> <div class="flex items-center"> <select id="shelfColor" class="custom-select flex-grow" onchange="updateOrderSummary(); updateSwatchDisplay('shelfColor', 'shelfColorSwatchDisplay');"> <option value="">-- Wybierz --</option> <option value="#8B5A2B" data-color="#8B5A2B">Dąb Craft Złoty</option> <option value="#FFFFFF" data-color="#FFFFFF">Biały matowy</option> <option value="#000000" data-color="#000000">Czarny matowy</option> </select> <span id="shelfColorSwatchDisplay" class="color-swatch-display"></span> </div> </div> <details class="color-samples-details" id="materialSamplesDetails"> <summary> <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2 text-stone-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5C7.305 4.5 3.135 7.515 1.5 12c1.635 4.485 5.805 7.5 10.5 7.5s8.865-3.015 10.5-7.5C20.865 7.515 16.695 4.5 12 4.5z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 9a3 3 0 100 6 3 3 0 000-6z" /></svg> <span>Zobacz próbki kolorów</span> <svg class="w-4 h-4 summary-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg> </summary> <div id="materialSwiper" class="swiper"> <div class="swiper-wrapper"> <div class="swiper-slide"> <img src="img/dabduze.jpg" alt="Dąb Craft Złoty"> <div class="material-name">Dąb Craft Złoty - struktura drewna</div> </div> <div class="swiper-slide"> <img src="img/bialyduze.jpg" alt="Biały matowy"> <div class="material-name">Biały matowy - gładki</div> </div> <div class="swiper-slide"> <img src="img/czarnyduze.jpg" alt="Czarny matowy"> <div class="material-name">Czarny matowy - gładki</div> </div> </div> <div class="material-swiper-button-prev swiper-button-prev"></div> <div class="material-swiper-button-next swiper-button-next"></div> </div> </details> </div>
        </div>
<div class="w-full md:w-2/3 flex flex-col items-center mb-8 md:mb-0 order-2 md:order-2">
             <div id="shelfContainer" class="mx-auto relative">
                <div id="mobileShelfInfo">
                    <p id="mobileInfoGap"></p>
                    <p id="mobileInfoDividers"></p>
                </div>
                <button id="collapse3dPanelButton" onclick="close3dPanel()" title="Zwiń podgląd 3D" class="z-20">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /> </svg> <span class="sr-only">Zwiń podgląd 3D</span>
                </button>
                
                <div id="mobile3dActionsContainer">
                     <div id="mobilePriceIcon" class="mobile-3d-action-btn">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" />
                         </svg>
                         <span id="mobilePriceValue" class="price-value"></span>
                     </div>
                     <button id="mobileGoToSummaryBtn" class="mobile-3d-action-btn" title="Przewiń do podsumowania">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                     </button>
                </div>

                <div id="mobilePanelIcons" class="hidden md:hidden">
                    <button onclick="scrollToElementAndHighlight('shelfTypeSectionAnchor', 'start', this);" title="Przewiń do rodzaju półki">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 1.905c-.007.379.137.75.431.99l1.005.828c.428.355.53 1.005.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-1.905c.007-.379-.137-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" /> <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /> </svg>
                        <span>Rodzaj</span>
                        <small id="mobileIconDetailsType" class="mobile-icon-details mobile-icon-prompt">wybierz</small>
                    </button>
                    <button onclick="scrollToElementAndHighlight('dimensionSectionAnchor', 'start', this);" title="Przewiń do wymiarów">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12h15m0 0l-6.75-6.75M19.5 12l-6.75 6.75" /> <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v16.5M20.25 3.75v16.5" /> </svg>
                        <span>Wymiary</span>
                        <small id="mobileIconDetailsDimensions" class="mobile-icon-details mobile-icon-prompt">wybierz</small>
                    </button>
                    <button onclick="scrollToElementAndHighlight('colorSectionAnchor', 'start', this);" title="Przewiń do kolorów">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.043-.025a15.994 15.994 0 011.622-3.395m3.42 3.42a15.995 15.995 0 004.764-4.648l3.876-5.814a1.151 1.151 0 00-1.597-1.597L14.146 6.32a15.996 15.996 0 00-4.649 4.763m3.42 3.42a6.776 6.776 0 00-3.42-3.42" /> </svg>
                        <span>Kolory</span>
                        <small id="mobileIconDetailsColors" class="mobile-icon-details mobile-icon-prompt">wybierz</small>
                    </button>
                    <button onclick="scrollToElementAndHighlight('shelfCountSection', 'start', this);" title="Przewiń do dodawania półek">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9h16.5M3.75 15h16.5" />
                        </svg>
                        <span>Półki</span>
                        <small id="mobileIconDetailsShelves" class="mobile-icon-details mobile-icon-prompt">wybierz</small>
                    </button>
                </div>
                  
                <div id="threeJsCanvasWrapper" class="flex-grow"> 
                    </div>
                <div id="mugShelfDividerIconsContainer" class="z-10">
                    <div id="dividerIconGroup"> 
                        <div class="divider-control-item">
                            <button id="addTopDividerBtn" data-divider-type="top" title="Dodaj/Usuń górną przegródkę" class="mobile-divider-icon-small"> 
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M4 4h16v16H4V4zm0 6h16" /> </svg> 
                            </button>
                            <span class="divider-label">góra</span>
                        </div>
                        <div class="divider-control-item">
                            <button id="addMiddleDividerBtn" data-divider-type="middle" title="Dodaj/Usuń środkową przegródkę" class="mobile-divider-icon-small"> 
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M4 4h16v16H4V4zm0 8h16" /> </svg> 
                            </button>
                            <span class="divider-label">środek</span>
                        </div>
                        <div class="divider-control-item">
                             <button id="addBottomDividerBtn" data-divider-type="bottom" title="Dodaj/Usuń dolną przegródkę" class="mobile-divider-icon-small"> 
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M4 4h16v16H4V4zm0 10h16" /> </svg> 
                            </button>
                            <span class="divider-label">dół</span>
                        </div>
                    </div>
                    <div class="mount-divider"></div>
                    <div id="mountIconGroup">
                        <button id="mobileMountHangingStripBtn" title="Wybierz montaż wiszący" class="mount-text-button">
                           wisząca
                        </button>
                        <button id="mobileMountStandingStripBtn" title="Wybierz montaż stojący" class="mount-text-button">
                           stojąca
                        </button>
                    </div>
                    <div id="dividerTooltip">Kliknij ikonę, by dodać/usunąć przegródki</div>
                </div>
                <div id="mobileMugShelfMountPanel"></div>
             </div> 
            <div class="text-sm text-stone-600 italic mt-2 text-center md:hidden"></div>
             <div class="text-sm text-stone-600 italic mt-2 text-center hidden md:block"> Obróć lub zbliż model (przeciągnij myszką) </div>
             <div id="shelfCountSection" class="p-6 shadow rounded-lg bg-white border border-stone-200 transition-shadow duration-200 hover:shadow-md mt-0,1 md:mt-8 w-full max-w-lg">
                 <h2 class="text-lg font-semibold mb-4 flex items-center text-stone-800">
                     <svg class="h-6 w-6 mr-2 text-green-600 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                         <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9h16.5M3.75 15h16.5" />
                     </svg>
                     Dodaj półki wewnętrzne
                 </h2>
                 <select id="shelfCount" class="custom-select w-full" onchange="updatePreview(); updateOrderSummary();">
                     <option value="">-- Wybierz --</option>
                 </select>
                 
                 <div class="mt-4 pt-3 border-t border-dashed border-stone-200 space-y-1">
                     <p id="gapDisplay" class="text-xs text-stone-500">
                         Odległość między półkami: <span id="gapSummaryDisplay" class="font-semibold text-stone-600"></span>
                     </p>
                     <div id="desktopDividerDimensionsInfo" style="display: none;" class="text-xs text-stone-500">
                         Wymiar przegródki: szer. 12,5cm, wys. 10,9cm
                     </div>
                 </div>
             </div>
             <details class="bg-emerald-50 border border-emerald-200 rounded-lg mt-8 w-full max-w-lg hidden md:block transition-shadow duration-200 hover:shadow-md overflow-hidden group"> <summary class="p-6 flex justify-between items-center cursor-pointer list-none hover:bg-emerald-100 transition-colors duration-150"> <h2 class="text-xl font-semibold text-emerald-800">Jak zamówić półkę?</h2> <span class="marker transform transition-transform duration-200 rotate-0 group-open:rotate-180"> <svg class="w-5 h-5 text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /> </svg> </span> </summary> <div class="p-6 pt-2 border-t border-emerald-200">
                <ul class="list-none instruction-list text-stone-700 space-y-3 text-sm md:text-base">
                    <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 1.905c-.007.379.137.75.431.99l1.005.828c.428.355.53 1.005.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-1.905c.007-.379-.137-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg> <span>Wybierz rodzaj półki, wymiary, kolory i liczbę półek.</span></li>
                    <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" /></svg> <span>Dodaj skonfigurowaną półkę do koszyka. Możesz dodać wiele różnych półek.</span></li>
                    <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" /></svg> <span>Gdy wszystko gotowe, kliknij w ikonę koszyka, aby zobaczyć podsumowanie.</span></li>
                    <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 4.25-3-3m0 0-3 3m3-3v12.75" /></svg> <span>W podsumowaniu strona poda łączną cenę i wszystkie kody zamówień.</span></li>
                    <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" /></svg> <span>Kliknij zielony przycisk, aby skopiować kody i przejść na Allegro.</span></li>
                    <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" /></svg> <span>Na Allegro zamów tyle sztuk, ile wynosi **łączna cena** (np. 350 zł = 350 szt.).</span></li>
                    <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg> <span>W polu „Uwagi do zakupu” wklej **wszystkie** skopiowane kody.</span></li>
                    <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Z" /></svg> <span>Opłać zamówienie – my zajmiemy się resztą! 😊</span></li>
                </ul>
                   </div>
              </details> <div class="mt-8 bg-white p-6 rounded-lg shadow-md text-center border border-stone-200 transition-shadow duration-200 hover:shadow-lg w-full max-w-lg">
                   <h3 class="text-stone-700 font-semibold mb-3 text-base">Co mówią nasi klienci?</h3>
                   <div id="customerReview" class="text-stone-600 text-base italic review-fade-enter flex items-center justify-center space-x-2 min-h-[4em]"></div>
               </div>
            </div>
<div class="w-full md:w-1/3 p-6 bg-stone-50 border border-stone-200 rounded-lg space-y-6 order-3 md:order-3">
             <div class="order-summary bg-white shadow-lg rounded-lg p-6 transition-shadow duration-200 hover:shadow-xl">
                <div class="order-summary-header">
                    <h2 class="text-xl font-semibold text-stone-800">Podsumowanie</h2>
                </div>
                <ul class="divide-y divide-stone-200 text-sm">
                    <li class="py-2 flex justify-between items-center"><span class="font-medium text-stone-600">Rodzaj półki:</span><span id="shelfTypeSummary" class="text-stone-900 text-right">nie wybrano</span></li>
                    <li id="mugShelfMountSummaryItem" class="py-2 flex justify-between items-center" style="display: none;"><span class="font-medium text-stone-600">Montaż:</span><span id="mugShelfMountSummary" class="text-stone-900 text-right"></span></li>
                    <li class="py-2 flex justify-between items-center"><span class="font-medium text-stone-600">Szerokość:</span><span id="widthSummary" class="text-stone-900"></span></li>
                    <li class="py-2 flex justify-between items-center"><span class="font-medium text-stone-600">Wysokość:</span><span id="heightSummary" class="text-stone-900"></span></li>
                    <li class="py-2 flex justify-between items-center"><span class="font-medium text-stone-600">Głębokość:</span><span id="depthSummary" class="text-stone-900"></span></li>
                    <li class="py-2 flex justify-between items-center"><span class="font-medium text-stone-600">Kolor boków:</span><span id="sideColorSummary" class="text-stone-900 text-right">nie wybrano</span></li>
                    <li class="py-2 flex justify-between items-center"><span id="shelfColorSummaryLabel" class="font-medium text-stone-600">Kolor półek i podstaw:</span><span id="shelfColorSummary" class="text-stone-900 text-right">nie wybrano</span></li>
                    <li class="py-2 flex justify-between items-center"><span class="font-medium text-stone-600">Ilość półek wewn.:</span><span id="shelfCountSummary" class="text-stone-900"></span></li>
                    <li class="py-2 flex justify-between items-center"><span class="font-medium text-stone-600">Odległość między półkami:</span><span id="gapSummary" class="text-stone-900"></span></li>
                    <li class="py-2 flex justify-between items-center"><span class="font-medium text-stone-600">Opcje dodatkowe:</span><span id="extraOptionsSummary" class="text-stone-900 text-right">standardowa</span></li>
                    <li class="pt-2 pb-1 flex justify-between items-center"><span class="font-medium text-stone-600">Materiał:</span><span class="text-stone-900 text-right">płyta laminowana gr. 1,8 cm</span></li>
                    <li class="pt-1 pb-2 flex justify-between items-center"><span class="font-medium text-stone-600">Termin realizacji:</span><span class="text-stone-900 text-right">3‑5 dni roboczych</span></li>
                </ul>

                <div class="mt-5 pt-4 border-t border-stone-200">
                    <div id="priceAndActionsContainer" style="display: none;">
                        
                        <div class="bg-stone-100 border border-stone-200 rounded-lg p-4 mb-4 text-center">
                             <div class="flex justify-center items-baseline w-full">
                                <span class="text-lg font-medium text-stone-600 mr-3">Cena:</span>
                                <span class="text-red-600 font-bold text-3xl" id="priceSummary"></span>
                             </div>
                        </div>

                        <button id="addToCartBtn" class="group w-full px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg text-lg font-semibold transition-all duration-150 ease-in-out flex items-center justify-center space-x-2 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 active:scale-95 mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span>Dodaj do koszyka</span>
                        </button>
                        
                        <div id="desktopCartContainer" class="group cursor-pointer" title="Otwórz koszyk">
    <div class="w-full bg-white border-2 border-stone-200 group-hover:border-green-300 rounded-lg p-3 shadow-sm group-hover:shadow-lg transition-all duration-200 flex items-center justify-center text-center relative">
        
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-stone-500 group-hover:text-green-600 transition-colors" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>

        <span class="ml-2 text-lg font-semibold text-stone-700 group-hover:text-green-700">Zobacz koszyk</span>
        
        <span class="cart-badge" style="display: none; position: absolute; top: -10px; right: -10px; width: 1.5rem; height: 1.5rem; font-size: 0.8rem;">0</span>
    </div>
</div>

                    </div>
                    <p id="priceHint" class="text-stone-500 text-xs mt-2 text-center">Wybierz wszystkie parametry, aby zobaczyć cenę.</p>
                     
                    <div id="viewOrderSection" class="mt-6 pt-4 border-t border-dashed border-stone-300">
                         <label for="viewOrderCodeInput">Masz kod zamówienia?</label>
                         <input type="text" id="viewOrderCodeInput" class="text-base" placeholder="Wklej kod tutaj, aby zobaczyć szczegóły...">
                    </div>
                </div>
            </div>
        </div>
    </div>
<script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
<script>
// --- Zmienne globalne i elementy DOM ---
        let scene, camera, renderer, shelfGroup, controls;
        let shelfContainer, threeJsCanvasWrapper, materialSwiperInstance, gallerySwiperInstance;
        let shelfTypeSelect, widthSelect, heightSelect, depthSelect, shelfCountSelect;
        let customWidthInput, customWidthDisplay, customWidthFee;
        let shelfTypeOptionsDiv, widthSelectionArea, dimensionSectionAnchor, colorSectionAnchor, shelfTypeSectionAnchor;
        let heightLabel, depthLabel, sideColorSelect, shelfColorSelect;
        let mugShelfSpecificOptionsContainer, mugShelfMountOptionsDiv, mugShelfDividersOptionsDiv;
        let dividersTopCheckbox, dividersMiddleCheckbox, dividersBottomCheckbox;
        let configuratorSection, shelfCountSection;
        let galleryTabsContainer, galleryGridContainer, galleryImageArea, galleryPrevArrow, galleryNextArrow;
        let show3dButton, collapse3dPanelButton;
        let autoRotateEnabled = true;
        const initialCameraPosition = { x: 4, y: 5, z: 7 };

        let cart = [];
        let desktopCartContainer, cartPanel, cartPanelOverlay, cartPanelCloseBtn, cartItemsContainer, cartEmptyMessage, cartTotalPrice, cartCheckoutButton, cartBadges, mobileCartButton, cartDiscountReminder;
        let cartSubtotalLine, cartSubtotalPrice, cartDiscountLine, cartDiscountAmount;
        let mugShelfDividerIconsContainer, addTopDividerBtn, addMiddleDividerBtn, addBottomDividerBtn, dividerTooltip;
        let mobileMugShelfMountPanel, mobileMountHangingStripBtn, mobileMountStandingStripBtn;
        let mobileIconDetailsType, mobileIconDetailsDimensions, mobileIconDetailsColors, mobileIconDetailsShelves;
        let mobile3dActionsContainer, mobilePriceValue, mobileGoToSummaryBtn;
        let desktopDividerDimensionsInfo;
        let viewOrderCodeInput, orderDetailsModalOverlay, orderDetailsModal, modalCloseButton, modalOrderCodeSpan, modalOrderSummaryP;
        let priceAndActionsContainer, priceHint, addToCartBtn;
        let imageLightbox, lightboxImage, lightboxCloseBtn;
        
        // Zmienna do zarządzania listenerem scrolla w modalu
        let modalScrollListener = null;

        // --- Predefined Shelf Configurations ---
        const wiszace_configs = [
            { type: 'hanging', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '80', width: '44', depth: '10', shelfCount: '5' }, { type: 'hanging', sideColor: '#FFFFFF', shelfColor: '#FFFFFF', height: '80', width: '44', depth: '10', shelfCount: '5' }, { type: 'hanging', sideColor: '#8B5A2B', shelfColor: '#FFFFFF', height: '80', width: '44', depth: '10', shelfCount: '5' }, { type: 'hanging', sideColor: '#000000', shelfColor: '#8B5A2B', height: '80', width: '44', depth: '10', shelfCount: '5' }, { type: 'hanging', sideColor: '#000000', shelfColor: '#000000', height: '80', width: '44', depth: '10', shelfCount: '5' }, { type: 'hanging', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '10', shelfCount: '2' }, { type: 'hanging', sideColor: '#FFFFFF', shelfColor: '#FFFFFF', height: '40', width: '60', depth: '10', shelfCount: '2' }, { type: 'hanging', sideColor: '#000000', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '10', shelfCount: '2' }, { type: 'hanging', sideColor: '#000000', shelfColor: '#000000', height: '40', width: '60', depth: '10', shelfCount: '2' }, { type: 'hanging', sideColor: '#8B5A2B', shelfColor: '#FFFFFF', height: '40', width: '60', depth: '10', shelfCount: '2' }, { type: 'hanging', sideColor: '#FFFFFF', shelfColor: '#FFFFFF', height: '60', width: '44', depth: '10', shelfCount: '3', noTopShelf: true }, { type: 'hanging', sideColor: '#000000', shelfColor: '#8B5A2B', height: '60', width: '44', depth: '10', shelfCount: '3', noTopShelf: true }, { type: 'hanging', sideColor: '#FFFFFF', shelfColor: '#8B5A2B', height: '60', width: '44', depth: '10', shelfCount: '3', noTopShelf: true }, { type: 'hanging', sideColor: '#000000', shelfColor: '#000000', height: '60', width: '44', depth: '10', shelfCount: '3', noTopShelf: true }, { type: 'hanging', sideColor: '#FFFFFF', shelfColor: '#8B5A2B', height: '40', width: '44', depth: '10', shelfCount: '2', noTopShelf: true }
        ];
        const stojace_configs = [
            { type: 'standing', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '10', shelfCount: '2' }, { type: 'standing', sideColor: '#FFFFFF', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '10', shelfCount: '2' }, { type: 'standing', sideColor: '#000000', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '10', shelfCount: '2' }, { type: 'standing', sideColor: '#FFFFFF', shelfColor: '#FFFFFF', height: '40', width: '60', depth: '10', shelfCount: '2' }, { type: 'standing', sideColor: '#000000', shelfColor: '#000000', height: '40', width: '60', depth: '10', shelfCount: '2' }, { type: 'standing', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '10', noBottomShelf: true }, { type: 'standing', sideColor: '#8B5A2B', shelfColor: '#FFFFFF', height: '40', width: '60', depth: '10', noBottomShelf: true }, { type: 'standing', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '15', shelfCount: '2', noBottomShelf: true, noTopShelf: true }, { type: 'standing', sideColor: '#000000', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '15', shelfCount: '2', noBottomShelf: true, noTopShelf: true }, { type: 'standing', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '10', shelfCount: '2', noBottomShelf: true, noTopShelf: true }, { type: 'standing', sideColor: '#000000', shelfColor: '#8B5A2B', height: '40', width: '44', depth: '10', shelfCount: '2', noBottomShelf: true, noTopShelf: true }
        ];
        const kubki_configs = [
            { type: 'mug_shelf', mount: 'standing', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '40', width: '44', depth: '10', dividers: { top: true, middle: true, bottom: true } }, { type: 'mug_shelf', mount: 'standing', sideColor: '#000000', shelfColor: '#8B5A2B', height: '40', width: '44', depth: '10', dividers: { top: true, middle: true, bottom: true } }, { type: 'mug_shelf', mount: 'standing', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '10', dividers: { top: true, middle: true, bottom: true } }, { type: 'mug_shelf', mount: 'standing', sideColor: '#8B5A2B', shelfColor: '#FFFFFF', height: '40', width: '60', depth: '10', dividers: { top: true, middle: true, bottom: true } }, { type: 'mug_shelf', mount: 'standing', sideColor: '#8B5A2B', shelfColor: '#000000', height: '40', width: '60', depth: '10', dividers: { top: true, middle: true, bottom: true } }, { type: 'mug_shelf', mount: 'standing', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '40', width: '44', depth: '10', dividers: { top: true, middle: true, bottom: true } }, { type: 'mug_shelf', mount: 'standing', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '10', dividers: { top: true, middle: false, bottom: false } }, { type: 'mug_shelf', mount: 'standing', sideColor: '#8B5A2B', shelfColor: '#000000', height: '40', width: '60', depth: '10', dividers: { top: true, middle: false, bottom: true } }, { type: 'mug_shelf', mount: 'standing', sideColor: '#8B5A2B', shelfColor: '#FFFFFF', height: '40', width: '60', depth: '10', dividers: { top: true, middle: false, bottom: true } }, { type: 'mug_shelf', mount: 'hanging', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '10', dividers: { top: true, middle: true, bottom: true } }, { type: 'mug_shelf', mount: 'hanging', sideColor: '#8B5A2B', shelfColor: '#FFFFFF', height: '40', width: '60', depth: '10', dividers: { top: true, middle: true, bottom: true } }, { type: 'mug_shelf', mount: 'hanging', sideColor: '#8B5A2B', shelfColor: '#000000', height: '40', width: '60', depth: '10', dividers: { top: true, middle: true, bottom: true } }, { type: 'mug_shelf', mount: 'standing', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '60', width: '44', depth: '10', dividers: { top: true, middle: true, bottom: true } }, { type: 'mug_shelf', mount: 'standing', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '60', width: '44', depth: '10', dividers: { top: true, middle: true, bottom: true } }, { type: 'mug_shelf', mount: 'standing', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '40', width: '84', depth: '10', dividers: { top: true, middle: true, bottom: true }}
        ];
        const predefinedShelfConfigurations = [ wiszace_configs, stojace_configs, kubki_configs ];
        const originalPreviewMaterialParams = { color: 0x777777, metalness: 0, roughness: 0.6 };
        let originalWidthOptions = [];
        let originalHeightOptions = [];
        const pricing = {"34":{"40":{"10":{"2":150},"15":{"2":250}},"60":{"10":{"2":175,"3":200},"15":{"2":275,"3":300}},"80":{"10":{"2":200,"3":225,"4":250,"5":279},"15":{"2":300,"3":325,"4":350,"5":379}}},"44":{"40":{"10":{"2":169},"15":{"2":269}},"60":{"10":{"2":179,"3":189},"15":{"2":279,"3":289}},"80":{"10":{"2":200,"3":250,"4":275,"5":299},"15":{"2":300,"3":350,"4":375,"5":399}}},"50":{"40":{"10":{"2":179},"15":{"2":279}},"60":{"10":{"2":189,"3":199},"15":{"2":289,"3":299}},"80":{"10":{"2":250,"3":250,"4":300,"5":329},"15":{}}},"60":{"40":{"10":{"2":179},"15":{"2":279}},"60":{"10":{"2":209,"3":219},"15":{"2":309,"3":319}},"80":{"10":{"2":250,"3":275,"4":325,"5":319},"15":{}}}};
        const mugShelfPricing = {
            "44": { "40": 169, "60": 189 },
            "60": { "40": 179, "60": 219 },
            "84": { "40": 299 }
        };
        const galleryData = [ { title: 'Półki wiszące', imgs: ['img/1.jpg', 'img/2.jpg', 'img/3.jpg', 'img/4.jpg', 'img/5.jpg', 'img/6.jpg', 'img/7.jpg', 'img/8.jpg', 'img/9.jpg', 'img/10.jpg', 'img/11.jpg', 'img/12.jpg', 'img/13.jpg', 'img/14.jpg', 'img/15.jpg'] }, { title: 'Półki stojące', imgs: ['img/1a.jpg', 'img/2a.jpg', 'img/3a.jpg', 'img/4a.jpg', 'img/5a.jpg', 'img/6a.jpg', 'img/7a.jpg', 'img/8a.jpg', 'img/9a.jpg', 'img/10a.jpg', 'img/11a.jpg'] }, { title: 'Półki na kubki', imgs: ['img/1b.jpg', 'img/2b.jpg', 'img/3b.jpg', 'img/4b.jpg', 'img/5b.jpg', 'img/6b.jpg', 'img/7b.jpg', 'img/8b.jpg', 'img/9b.jpg', 'img/10b.jpg', 'img/11b.jpg', 'img/12b.jpg', 'img/13b.jpg', 'img/14b.jpg', 'img/15b.jpg'] } ];
        const codeToValue = { type: { s: 'standing', h: 'hanging', m: 'mug_shelf' }, color: { '0': '#8B5A2B', '1': '#FFFFFF', '2': '#000000' }, mugMount: { h: 'hanging', s: 'standing' } };
        const valueToCode = { type: { standing: 's', hanging: 'h', mug_shelf: 'm' }, color: { '#8B5A2B': '0', '#FFFFFF': '1', '#000000': '2' } };

        
        function checkCodesVisibility() {
            const modalBody = document.querySelector('#cartSummaryModal .modal-body');
            const codesSection = document.getElementById('codesSection');
            const scrollToBtn = document.getElementById('scrollToCodesBtn');

            if (!modalBody || !codesSection || !scrollToBtn) return;
            
            const modalRect = modalBody.getBoundingClientRect();
            const codesRect = codesSection.getBoundingClientRect();

            if (codesRect.bottom > modalRect.bottom + 5) {
                scrollToBtn.classList.add('visible');
            } else {
                scrollToBtn.classList.remove('visible');
            }
        }

        function animateCodeTyping(fullText) {
            const textarea = document.getElementById('cartSummaryAllCodes');
            const cursor = document.getElementById('typingCursor');
            if (!textarea || !cursor) return;

            textarea.value = '';
            cursor.style.display = 'block';

            const lines = fullText.split('\n');
            let currentLine = 0;
            let currentChar = 0;
            const typingSpeed = 120;

            function type() {
                if (currentLine < lines.length) {
                    const line = lines[currentLine];
                    if (currentChar < line.length) {
                        textarea.value += line.charAt(currentChar);
                        currentChar++;
                        setTimeout(type, typingSpeed);
                    } else {
                        if (currentLine < lines.length - 1) {
                            textarea.value += '\n';
                        }
                        currentLine++;
                        currentChar = 0;
                        setTimeout(type, typingSpeed * 4);
                    }
                } else {
                    cursor.style.display = 'none';
                    checkCodesVisibility();
                }
            }
            type();
        }

        function increaseQuantity(itemCode) {
            const item = cart.find(i => i.code === itemCode);
            if (item) { item.quantity++; }
            updateCartDisplay();
        }

        function decreaseQuantity(itemCode) {
            const item = cart.find(i => i.code === itemCode);
            if (item && item.quantity > 1) { item.quantity--; } 
            else { cart = cart.filter(i => i.code !== itemCode); }
            updateCartDisplay();
        }
        
        function removeFromCart(itemCode) {
            cart = cart.filter(item => item.code !== itemCode);
            updateCartDisplay();
        }
        
        function calculateCartTotal() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let discount = 0;
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            if (totalItems >= 2) {
                const allPrices = [];
                cart.forEach(item => { for (let i = 0; i < item.quantity; i++) { allPrices.push(item.price); } });
                const minPrice = Math.min(...allPrices);
                discount = minPrice * 0.25;
            }
            const total = subtotal - discount;
            return { subtotal, discount, total };
        }
        
        function openCart() {
            if (cartPanel && cartPanelOverlay) {
                cartPanel.classList.add('visible');
                cartPanelOverlay.classList.add('visible');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeCart() {
            if (cartPanel && cartPanelOverlay) {
                cartPanel.classList.remove('visible');
                cartPanelOverlay.classList.remove('visible');
                document.body.style.overflow = '';
            }
        }
        
        async function addToCart() {
            const orderCode = generateOrderCode();
            const priceDetails = computePriceDetailed();
            if (!orderCode || !priceDetails) { alert("Proszę, dokończ konfigurację półki przed dodaniem jej do koszyka."); return; }
            const existingItem = cart.find(item => item.code === orderCode);
            if (existingItem) {
                increaseQuantity(existingItem.code);
                openCart();
                const itemElement = cartItemsContainer.querySelector(`[data-code="${existingItem.code}"]`);
                if(itemElement) { itemElement.classList.remove('section-highlight-flash'); void itemElement.offsetWidth; itemElement.classList.add('section-highlight-flash'); }
                return;
            }
            const activeAddToCartButton = document.getElementById('addToCartBtn');
            const originalButtonContent = activeAddToCartButton.innerHTML;
            activeAddToCartButton.innerHTML = `<svg class="animate-spin h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <span>Generuję...</span>`;
            activeAddToCartButton.disabled = true;
            try {
                const snapshotDataUrl = await generate3dSnapshotFromCurrentModel();
                const newItem = { name: shelfTypeSelect.options[shelfTypeSelect.selectedIndex].text, summary: `${document.getElementById("widthSummary").textContent} x ${document.getElementById("heightSummary").textContent} x ${document.getElementById("depthSummary").textContent}`, shelfCountText: document.getElementById("shelfCountSummary").textContent, gapInfo: document.getElementById("gapSummary").textContent, sideColor: document.getElementById("sideColorSummary").textContent, shelfColor: document.getElementById("shelfColorSummary").textContent, extras: document.getElementById("extraOptionsSummary").textContent, price: priceDetails.total, code: orderCode, quantity: 1, snapshot: snapshotDataUrl };
                const cartIcon = window.innerWidth >= 768 ? desktopCartContainer : document.getElementById('mobileCartButton');
                const startRect = activeAddToCartButton.getBoundingClientRect(); 
                const endRect = cartIcon.getBoundingClientRect();
                const flyingShelf = document.createElement('img');
                flyingShelf.src = snapshotDataUrl;
                flyingShelf.className = 'shelf-to-cart-animation';
                document.body.appendChild(flyingShelf);
                flyingShelf.style.left = `${startRect.left + startRect.width / 2 - 50}px`;
                flyingShelf.style.top = `${startRect.top + startRect.height / 2 - 50}px`;
                flyingShelf.style.width = `100px`;
                flyingShelf.style.height = `100px`;
                flyingShelf.getBoundingClientRect();
                flyingShelf.style.transform = `translate(${endRect.left - startRect.left}px, ${endRect.top - startRect.top}px) scale(0.2)`;
                flyingShelf.style.opacity = '0';
                cart.push(newItem);
                setTimeout(() => { if(document.body.contains(flyingShelf)) document.body.removeChild(flyingShelf); updateCartDisplay(); openCart(); }, 1000);
            } catch (e) {
                console.error("Nie udało się wygenerować miniatury przy dodawaniu do koszyka:", e);
                alert("Wystąpił błąd podczas generowania podglądu. Spróbuj ponownie.");
            } finally {
                 activeAddToCartButton.innerHTML = originalButtonContent;
                 activeAddToCartButton.disabled = false;
            }
        }
        
        function updateCartDisplay() {
            if (!cartItemsContainer || !cartBadges) return;
            cartItemsContainer.innerHTML = '';
            if (cart.length === 0) { if(cartEmptyMessage) { cartEmptyMessage.style.display = 'block'; cartItemsContainer.appendChild(cartEmptyMessage); }
            } else {
                if(cartEmptyMessage) cartEmptyMessage.style.display = 'none';
                cart.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex items-start p-2.5 border-b border-stone-200 last:border-b-0 gap-3';
                    itemElement.dataset.code = item.code;
                    itemElement.innerHTML = `
                        <div class="flex-shrink-0 w-20 h-20 bg-stone-100 rounded-md flex items-center justify-center overflow-hidden border border-stone-200">
                            ${item.snapshot ? `<img src="${item.snapshot}" alt="Miniatura półki" class="w-full h-full object-contain">` : ''}
                        </div>
                        <div class="flex-grow flex flex-col justify-between h-full min-h-[80px]">
                            <div>
                                <div class="flex justify-between items-start">
                                    <p class="font-semibold text-stone-800 leading-tight pr-2">${item.name}</p>
                                    <button onclick="removeFromCart('${item.code}')" class="text-stone-400 hover:text-red-500 transition-colors p-1 -mt-1 -mr-1" title="Usuń z koszyka">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                                    </button>
                                </div>
                                <p class="text-xs text-stone-500">${item.summary} | Boki: ${item.sideColor} | Półki: ${item.shelfColor}</p>
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                <div class="quantity-controls">
                                    <button class="quantity-btn" onclick="decreaseQuantity('${item.code}')">-</button>
                                    <span class="quantity-display">${item.quantity}</span>
                                    <button class="quantity-btn" onclick="increaseQuantity('${item.code}')">+</button>
                                </div>
                                <p class="font-bold text-stone-800 text-base">${(item.price * item.quantity).toFixed(2)} zł</p>
                            </div>
                        </div>
                    `;
                    cartItemsContainer.appendChild(itemElement);
                });
            }
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            if (cartDiscountReminder) {
                if (totalItems === 1) { cartDiscountReminder.innerHTML = `✨ Świetny wybór! Dodaj jeszcze jedną półkę, aby otrzymać <b>-25% rabatu</b> na tańszą z nich.`; cartDiscountReminder.style.display = 'block';
                } else { cartDiscountReminder.style.display = 'none'; }
            }
            const totals = calculateCartTotal();
            if (totals.discount > 0) {
                cartSubtotalLine.style.display = 'flex';
                cartDiscountLine.style.display = 'flex';
                cartSubtotalPrice.textContent = `${totals.subtotal.toFixed(2)} zł`;
                cartDiscountAmount.textContent = `- ${totals.discount.toFixed(2)} zł`;
            } else {
                cartSubtotalLine.style.display = 'none';
                cartDiscountLine.style.display = 'none';
            }
            cartTotalPrice.textContent = `${totals.total.toFixed(2)} zł`;
            cartBadges.forEach(badge => { badge.textContent = totalItems; badge.style.display = totalItems > 0 ? 'flex' : 'none'; });
            if(mobileCartButton) { const mobileCartPriceSpan = mobileCartButton.querySelector('.mobile-cart-price'); if(mobileCartPriceSpan) { mobileCartPriceSpan.textContent = totalItems > 0 ? `${totals.total.toFixed(2)} zł` : 'Koszyk'; } }
            cartCheckoutButton.disabled = cart.length === 0;
        }
        
        function handleCheckout() {
            if (cart.length === 0) return;

            const scrollToCodesBtn = document.getElementById('scrollToCodesBtn');
            if (scrollToCodesBtn) { scrollToCodesBtn.classList.remove('visible', 'pulse-glow-animation'); }
            
            closeCart();
            const totals = calculateCartTotal();
            const allCodes = cart.flatMap(item => Array(item.quantity).fill(item.code)).join('\n');
            cartSummaryItemsContainer.innerHTML = '';
            cart.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = 'p-3 bg-stone-50 rounded-lg border border-stone-200 flex items-start gap-3';
                itemCard.innerHTML = `
                    <div class="summary-snapshot-container flex-shrink-0 w-20 h-20">
                        ${item.snapshot ? `<img src="${item.snapshot}" alt="Podgląd 3D półki: ${item.name}" class="w-full h-full object-contain" />` : '<div class="text-xs text-stone-500 p-2 flex items-center justify-center h-full">Brak podglądu</div>'}
                    </div>
                    <div class="flex-grow min-w-0">
                        <div class="flex justify-between items-start gap-2">
                            <div>
                                <p class="font-semibold text-sm text-stone-800 leading-tight">${item.name}</p>
                                <p class="text-xs text-stone-500">Ilość: ${item.quantity}</p>
                            </div>
                            <p class="font-bold text-lg text-stone-800 flex-shrink-0">${(item.price * item.quantity).toFixed(2)} zł</p>
                        </div>

                        <dl class="text-xs space-y-0.5 mt-2">
                            <div class="flex justify-between gap-2">
                                <dt class="text-stone-500">Wymiary:</dt>
                                <dd class="font-semibold text-stone-700 text-right">${item.summary}</dd>
                            </div>
                            <div class="flex justify-between gap-2">
                                <dt class="text-stone-500">Półki:</dt>
                                <dd class="font-semibold text-stone-700 text-right">${item.shelfCountText}</dd>
                            </div>
                            <div class="flex justify-between gap-2">
                                <dt class="text-stone-500">Kolor boków:</dt>
                                <dd class="font-semibold text-stone-700 text-right">${item.sideColor}</dd>
                            </div>
                             <div class="flex justify-between gap-2">
                                <dt class="text-stone-500">Kolor półek:</dt>
                                <dd class="font-semibold text-stone-700 text-right">${item.shelfColor}</dd>
                            </div>
                            <div class="flex justify-between gap-2">
                                <dt class="text-stone-500">Opcje:</dt>
                                <dd class="font-semibold text-stone-700 text-right">${item.extras}</dd>
                            </div>
                        </dl>
                    </div>
                `;
                cartSummaryItemsContainer.appendChild(itemCard);
            });
            if (totals.discount > 0) {
                cartSummarySubtotalLine.style.display = 'flex';
                cartSummaryDiscountLine.style.display = 'flex';
                cartSummarySubtotalPrice.textContent = `${totals.subtotal.toFixed(2)} zł`;
                cartSummaryDiscountAmount.textContent = `- ${totals.discount.toFixed(2)} zł`;
            } else {
                cartSummarySubtotalLine.style.display = 'none';
                cartSummaryDiscountLine.style.display = 'none';
            }
            cartSummaryTotalPrice.textContent = `${totals.total.toFixed(2)} zł`;
            cartSummaryInstructionUnits.innerHTML = `Na stronie Allegro dodaj do koszyka tyle sztuk, ile wynosi łączna cena Twojego zamówienia (<strong>${Math.round(totals.total)} szt.</strong>).`;
            const codesSection = document.getElementById('codesSection');
            const codesTextarea = document.getElementById('cartSummaryAllCodes');
            const typingCursor = document.getElementById('typingCursor');
            codesTextarea.value = '';
            codesSection.classList.remove('visible');
            if (typingCursor) typingCursor.style.display = 'none';
            cartSummaryModalOverlay.classList.add('visible');

            const modalBody = document.querySelector('#cartSummaryModal .modal-body');
            if (modalScrollListener) { modalBody.removeEventListener('scroll', modalScrollListener); }
            modalScrollListener = () => checkCodesVisibility();
            modalBody.addEventListener('scroll', modalScrollListener);
            
            setTimeout(() => {
                codesSection.classList.add('visible');
                animateCodeTyping(allCodes);
                checkCodesVisibility();
            }, 300);
        }
        
        function closeCartSummaryModal() {
            if (cartSummaryModalOverlay) {
                cartSummaryModalOverlay.classList.remove('visible');
                const modalBody = document.querySelector('#cartSummaryModal .modal-body');
                if (modalBody && modalScrollListener) {
                    modalBody.removeEventListener('scroll', modalScrollListener);
                    modalScrollListener = null;
                }
            }
        }

        function downloadFullCartSummary() {
            if (cart.length === 0) { alert("Koszyk jest pusty."); return; }
            const totals = calculateCartTotal();
            const allCodes = cart.flatMap(item => Array(item.quantity).fill(item.code)).join('\n');
            const date = new Date().toLocaleString('pl-PL');
            let content = `PODSUMOWANIE ZAMÓWIENIA\n`;
            content += `Data wygenerowania: ${date}\n`;
            content += `========================================\n\n`;
            cart.forEach((item, index) => {
                content += `PRODUKT ${index + 1}: ${item.name} (x${item.quantity})\n`;
                content += `  Wymiary: ${item.summary}\n`;
                content += `  Kolor boków: ${item.sideColor}\n`;
                content += `  Kolor półek: ${item.shelfColor}\n`;
                content += `  Ilość półek wewn.: ${item.shelfCountText}\n`;
                content += `  Opcje: ${item.extras}\n`;
                content += `  Cena jedn.: ${item.price.toFixed(2)} zł\n\n`;
            });
            content += `========================================\n`;
            if (totals.discount > 0) {
                content += `SUMA CZĘŚCIOWA: ${totals.subtotal.toFixed(2)} zł\n`;
                content += `RABAT (-25%): -${totals.discount.toFixed(2)} zł\n`;
            }
            content += `ŁĄCZNIE DO ZAPŁATY: ${totals.total.toFixed(2)} zł\n\n`;
            content += `KODY ZAMÓWIEŃ DO WKLEJENIA NA ALLEGRO:\n`;
            content += `${allCodes}\n`;
            content += `========================================\n`;
            const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            const filenameDate = new Date().toISOString().slice(0, 10);
            link.download = `zamowienie-polki-${filenameDate}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function applyShelfConfigurationFromGallery(galleryIndex, imageIndex) {
            const config = predefinedShelfConfigurations[galleryIndex]?.[imageIndex];
            if (!config) {
                console.error('Configuration not found for galleryIndex:', galleryIndex, 'imageIndex:', imageIndex);
                alert('Wybrana konfiguracja jest niedostępna. Proszę wybrać inną lub skonfigurować ręcznie.');
                return;
            }
            shelfTypeSelect.value = config.type;
            handleShelfTypeChange(true);
            if (config.type === 'mug_shelf') {
                if (Array.from(widthSelect.options).some(opt => opt.value === String(config.width))) { widthSelect.value = String(config.width);
                } else if (widthSelect.options.length > 0) { widthSelect.value = widthSelect.options[0].value; }
                if (Array.from(heightSelect.options).some(opt => opt.value === String(config.height))) { heightSelect.value = String(config.height);
                } else if (heightSelect.options.length > 0) { heightSelect.value = heightSelect.options[0].value; }
                handleMugShelfHeightChange();
                handleMugShelfWidthChange();
            } else {
                const widthValueString = String(config.width);
                const widthOptionExists = Array.from(widthSelect.options).some(opt => opt.value === widthValueString);
                if (widthOptionExists) { widthSelect.value = widthValueString;
                } else if (parseInt(widthValueString) >= 35 && parseInt(widthValueString) <= 59 && Array.from(widthSelect.options).some(opt => opt.value === 'custom')) { widthSelect.value = 'custom'; }
                checkCustomWidth();
                if (widthSelect.value === 'custom' && customWidthInput && parseInt(widthValueString) >= 35 && parseInt(widthValueString) <= 59) {
                     customWidthInput.value = widthValueString;
                     if(customWidthDisplay) customWidthDisplay.textContent = widthValueString + ' cm';
                }
                heightSelect.value = config.height;
                handleDimensionChange();
                if (Array.from(depthSelect.options).some(opt => opt.value === String(config.depth))) { depthSelect.value = String(config.depth);
                } else {
                     console.warn(`Depth ${config.depth} not available for current selections. Clearing or defaulting.`);
                     if(depthSelect.options.length > 0) depthSelect.value = depthSelect.options[0].value;
                }
                if (Array.from(shelfCountSelect.options).some(opt => opt.value === String(config.shelfCount))) { shelfCountSelect.value = String(config.shelfCount);
                } else {
                    console.warn(`Shelf count ${config.shelfCount} not available for height ${config.height}. Defaulting or clearing.`);
                    if (shelfCountSelect.options.length > 0) shelfCountSelect.value = shelfCountSelect.options[0].value;
                }
            }
            sideColorSelect.value = config.sideColor;
            shelfColorSelect.value = config.shelfColor;
            updateSwatchDisplay('sideColor', 'sideColorSwatchDisplay');
            updateSwatchDisplay('shelfColor', 'shelfColorSwatchDisplay');
            if (config.type === 'hanging' || config.type === 'standing') {
                const noTopShelfCheckboxElem = document.getElementById('noTopShelf');
                if (noTopShelfCheckboxElem) noTopShelfCheckboxElem.checked = !!config.noTopShelf;
                if (config.type === 'standing') {
                    const noBottomShelfCheckboxElem = document.getElementById('noBottomShelf');
                    if (noBottomShelfCheckboxElem) noBottomShelfCheckboxElem.checked = !!config.noBottomShelf;
                }
            } else if (config.type === 'mug_shelf') {
                const mountRadio = document.querySelector(`input[name="mugShelfMount"][value="${config.mount}"]`);
                if (mountRadio) mountRadio.checked = true;
                if (dividersTopCheckbox) dividersTopCheckbox.checked = !!config.dividers?.top;
                if (dividersMiddleCheckbox) dividersMiddleCheckbox.checked = !!config.dividers?.middle;
                if (dividersBottomCheckbox) dividersBottomCheckbox.checked = !!config.dividers?.bottom;
                updateDividerIconActiveStates();
                if (typeof updateMobileMountStripStates === "function") updateMobileMountStripStates();
            }
            updatePreview();
            updateOrderSummary();
        }

        function updateDividerIconsVisibility() {
            if (!shelfContainer || !shelfTypeSelect || !mugShelfDividerIconsContainer || !mobileMugShelfMountPanel || !dividerTooltip) return;
            const isMobile = window.innerWidth < 768;
            const isMugShelf = shelfTypeSelect.value === 'mug_shelf';
            const is3dPanelActive = shelfContainer.classList.contains('active');
            if (isMobile && isMugShelf && is3dPanelActive) {
                mugShelfDividerIconsContainer.classList.add('visible');
                mobileMugShelfMountPanel.classList.add('visible');
                if (!dividerTooltip.dataset.shown) {
                    dividerTooltip.classList.add('visible');
                    dividerTooltip.dataset.shown = 'true';
                    setTimeout(() => { dividerTooltip.classList.remove('visible'); }, 5000);
                }
                if (typeof updateMobileMountStripStates === "function") updateMobileMountStripStates();
            } else {
                mugShelfDividerIconsContainer.classList.remove('visible');
                mobileMugShelfMountPanel.classList.remove('visible');
            }
        }
        function updateDividerIconActiveStates() {
            if (addTopDividerBtn && dividersTopCheckbox) addTopDividerBtn.classList.toggle('active-divider-icon', dividersTopCheckbox.checked);
            if (addMiddleDividerBtn && dividersMiddleCheckbox) addMiddleDividerBtn.classList.toggle('active-divider-icon', dividersMiddleCheckbox.checked);
            if (addBottomDividerBtn && dividersBottomCheckbox) addBottomDividerBtn.classList.toggle('active-divider-icon', dividersBottomCheckbox.checked);
        }

        function updateMobileMountStripStates() {
            if (!mobileMountHangingStripBtn || !mobileMountStandingStripBtn || !mugShelfMountOptionsDiv) return;
            const currentMountValue = mugShelfMountOptionsDiv.querySelector('input[name="mugShelfMount"]:checked')?.value;
            mobileMountHangingStripBtn.classList.toggle('active-mount-strip', currentMountValue === 'hanging');
            mobileMountStandingStripBtn.classList.toggle('active-mount-strip', currentMountValue === 'standing');
        }

        function updateDividerDimensionVisibility() {
            if (!desktopDividerDimensionsInfo || !shelfTypeSelect || !heightSelect || !dividersTopCheckbox || !dividersMiddleCheckbox || !dividersBottomCheckbox) {
                 if(desktopDividerDimensionsInfo) desktopDividerDimensionsInfo.style.display = 'none';
                 return;
            }
            const isMugShelfType = shelfTypeSelect.value === 'mug_shelf';
            const areDividersSelectedForMugShelf = (dividersTopCheckbox?.checked || dividersMiddleCheckbox?.checked || dividersBottomCheckbox?.checked);
            const shouldShow = isMugShelfType && areDividersSelectedForMugShelf;
            try {
                if (shouldShow) {
                    const heightVal = heightSelect.value;
                    let dimensionsText = "wymiar przegródek szer. 12,5cm wys. 10,9cm";
                    if (heightVal === '60') { dimensionsText += " wnęka od podstawy wys. 18cm"; }
                    desktopDividerDimensionsInfo.textContent = dimensionsText;
                }
                desktopDividerDimensionsInfo.style.display = shouldShow ? 'block' : 'none';
            } catch (e) {
                console.error("Błąd podczas ustawiania wyświetlania dla desktopDividerDimensionsInfo:", e);
                 if(desktopDividerDimensionsInfo) desktopDividerDimensionsInfo.style.display = 'none';
            }
        }
        
        function updateMobileShelfInfo() {
            const mobileInfoGap = document.getElementById('mobileInfoGap');
            const mobileInfoDividers = document.getElementById('mobileInfoDividers');
            const mobileInfoContainer = document.getElementById('mobileShelfInfo');
            if (!mobileInfoGap || !mobileInfoDividers || !mobileInfoContainer) return;
            const shelfType = shelfTypeSelect.value;
            let showContainer = false;
            const gapText = document.getElementById('gapSummaryDisplay').textContent;
            if (shelfType !== 'mug_shelf' && gapText && gapText.includes('cm')) {
                mobileInfoGap.innerHTML = `Odległość między półkami: <strong class="font-semibold text-stone-600">${gapText}</strong>`;
                mobileInfoGap.style.display = 'block';
                showContainer = true;
            } else { mobileInfoGap.style.display = 'none'; }
            if (shelfType === 'mug_shelf') {
                mobileInfoDividers.innerHTML = `Przegródki: <strong class="font-semibold text-stone-600">12,5cm szer. x 10,9cm wys.</strong>`;
                mobileInfoDividers.style.display = 'block';
                showContainer = true;
            } else { mobileInfoDividers.style.display = 'none'; }
            mobileInfoContainer.style.display = showContainer ? 'block' : 'none';
        }

        function getCurrentWidth() { const widthOption = widthSelect.value; if (widthOption === 'custom') { if (customWidthInput) { return parseInt(customWidthInput.value) || 35; } else { return 35; } } else if (widthOption && widthOption !== "") { return parseInt(widthOption); } return NaN; }
        function updateDepthOptions() { const width = getCurrentWidth(); const height = heightSelect.value; const currentDepth = depthSelect.value; let availableDepths = ['10']; const widthValue = widthSelect.value; let allow15 = false; if (isNaN(width) || !height || height === "") { depthSelect.innerHTML = '<option value="">-- Wybierz --</option>'; depthSelect.value = ""; return; } if (widthValue === "custom") { const customWidth = width; const standardWidthKey = customWidth < 39 ? "34" : customWidth < 47 ? "44" : customWidth < 54 ? "50" : "60"; if (pricing[standardWidthKey]?.[height]?.['15'] && Object.keys(pricing[standardWidthKey]?.[height]?.['15']).length > 0) { allow15 = true; } } else { const standardWidthKey = String(width); if (pricing[standardWidthKey]?.[height]?.['15'] && Object.keys(pricing[standardWidthKey]?.[height]?.['15']).length > 0) { allow15 = true; } } if (allow15) availableDepths.push('15'); depthSelect.innerHTML = '<option value="">-- Wybierz --</option>'; availableDepths.forEach(depth => { const option = document.createElement('option'); option.value = depth; option.textContent = `${depth} cm`; depthSelect.appendChild(option); }); if (availableDepths.includes(currentDepth)) { depthSelect.value = currentDepth; } else { depthSelect.value = ""; } }
        function updateShelfCountOptions() { const height = heightSelect.value; const shelfType = shelfTypeSelect.value; const currentValue = shelfCountSelect.value; let options = { '0': 'brak półek' }; if (!height || height === "" || shelfType === 'mug_shelf') { shelfCountSelect.innerHTML = ''; if (!height || height === "") { const option = document.createElement('option'); option.value = '0'; option.textContent = 'brak półek'; shelfCountSelect.appendChild(option); shelfCountSelect.value = '0'; } return; } if (height === "40") options['2'] = '2 półki'; else if (height === "60") { options['2'] = '2 półki'; options['3'] = '3 półki'; } else if (height === "80") { options['2'] = '2 półki'; options['3'] = '3 półki'; options['4'] = '4 półki'; options['5'] = '5 półki'; } shelfCountSelect.innerHTML = ''; for (const value in options) { const option = document.createElement('option'); option.value = value; option.textContent = options[value]; shelfCountSelect.appendChild(option); } if (options.hasOwnProperty(currentValue)) { shelfCountSelect.value = currentValue; } else { shelfCountSelect.value = '0'; } }
        function checkCustomWidth() { const isCustom = widthSelect.value === 'custom'; if(customWidthInput && customWidthDisplay && customWidthFee) { customWidthInput.style.display = isCustom ? 'block' : 'none'; customWidthDisplay.style.display = isCustom ? 'inline' : 'none'; customWidthFee.style.display = isCustom ? 'inline' : 'none'; if (isCustom) { customWidthDisplay.textContent = customWidthInput.value + ' cm'; } } handleDimensionChange(); }
        function handleDimensionChange() { if (shelfTypeSelect.value !== 'mug_shelf') { updateDepthOptions(); updateShelfCountOptions(); } updatePreview(); updateOrderSummary(); }
        function handleMugShelfHeightChange() { const height = heightSelect.value; if (shelfCountSelect && mugShelfDividersOptionsDiv) { if (height === '60') { shelfCountSelect.innerHTML = '<option value="3">3 półki (stałe)</option>'; shelfCountSelect.value = '3'; mugShelfDividersOptionsDiv.style.display = 'block'; } else if (height === '40') { shelfCountSelect.innerHTML = '<option value="2">2 półki (stałe)</option>'; shelfCountSelect.value = '2'; mugShelfDividersOptionsDiv.style.display = 'block'; } else { shelfCountSelect.innerHTML = '<option value="">-- Wybierz --</option>'; shelfCountSelect.value = ''; mugShelfDividersOptionsDiv.style.display = 'none'; } if(dividersTopCheckbox) dividersTopCheckbox.checked = false; if(dividersMiddleCheckbox) dividersMiddleCheckbox.checked = false; if(dividersBottomCheckbox) dividersBottomCheckbox.checked = false; } updatePreview(); updateOrderSummary(); }
        function handleShelfTypeChange(isLoading = false) {
             const shelfColorLabel = document.getElementById('shelfColorLabel'); const shelfType = shelfTypeSelect.value;
             const noTopShelfCheckbox = document.getElementById("noTopShelf"); const noBottomShelfCheckbox = document.getElementById("noBottomShelf");
             if (shelfTypeOptionsDiv) { shelfTypeOptionsDiv.innerHTML = ''; shelfTypeOptionsDiv.style.display = 'none'; }
             if (mugShelfSpecificOptionsContainer) mugShelfSpecificOptionsContainer.style.display = 'none';
             if (mugShelfMountOptionsDiv) mugShelfMountOptionsDiv.style.display = 'none';
             if (mugShelfDividersOptionsDiv) mugShelfDividersOptionsDiv.style.display = 'none';
             restoreDimensionControls(); autoRotateEnabled = true;
             heightSelect.removeEventListener('change', handleMugShelfHeightChange); widthSelect.removeEventListener('change', handleMugShelfWidthChange);
             heightSelect.removeEventListener('change', handleDimensionChange);
             heightSelect.addEventListener('change', handleDimensionChange);
             if (dividerTooltip) { delete dividerTooltip.dataset.shown; dividerTooltip.classList.remove('visible'); }
             if (shelfType === 'standing' || shelfType === 'hanging') {
                 autoRotateEnabled = true; depthSelect.disabled = false; shelfCountSelect.disabled = false;
                 depthLabel.classList.remove('text-stone-400');
                 if (shelfTypeOptionsDiv) {
                     shelfTypeOptionsDiv.style.display = 'block'; if (shelfType === 'standing') { const topChecked = noTopShelfCheckbox?.checked ? 'checked' : ''; const bottomChecked = noBottomShelfCheckbox?.checked ? 'checked' : ''; shelfTypeOptionsDiv.innerHTML = `<label class="flex items-center space-x-2 text-sm cursor-pointer"><input type="checkbox" id="noTopShelf" class="rounded border-stone-300 text-green-600 shadow-sm focus:ring-green-500" onchange="updatePreview(); updateOrderSummary();" ${topChecked}> <span class="text-stone-700">Bez górnej półki</span></label><label class="flex items-center space-x-2 text-sm mt-1 cursor-pointer"><input type="checkbox" id="noBottomShelf" class="rounded border-stone-300 text-green-600 shadow-sm focus:ring-green-500" onchange="updatePreview(); updateOrderSummary();" ${bottomChecked}> <span class="text-stone-700">Bez dolnej półki (podstawy)</span></label>`; } else { const topChecked = noTopShelfCheckbox?.checked ? 'checked' : ''; shelfTypeOptionsDiv.innerHTML = `<label class="flex items-center space-x-2 text-sm mt-1 cursor-pointer"><input type="checkbox" id="noTopShelf" class="rounded border-stone-300 text-green-600 shadow-sm focus:ring-green-500" onchange="updatePreview(); updateOrderSummary();" ${topChecked}> <span class="text-stone-700">Bez górnej półki</span></label>`; }
                 }
             } else if (shelfType === 'mug_shelf') {
                 autoRotateEnabled = false;
                 widthSelect.innerHTML = '<option value="44">44 cm</option><option value="60">60 cm</option><option value="84">84 cm</option>';
                 heightSelect.innerHTML = '<option value="40">40 cm</option><option value="60">60 cm</option>';
                 widthSelect.removeEventListener('change', checkCustomWidth); widthSelect.addEventListener('change', handleMugShelfWidthChange);
                 heightSelect.removeEventListener('change', handleDimensionChange);
                 heightSelect.addEventListener('change', handleMugShelfHeightChange);
                 if(customWidthInput && customWidthDisplay && customWidthFee){ customWidthInput.style.display = 'none'; customWidthDisplay.style.display = 'none'; customWidthFee.style.display = 'none'; }
                 depthSelect.innerHTML = '<option value="10">10 cm (stała)</option>'; depthSelect.value = '10'; depthSelect.disabled = true;
                 depthLabel.classList.add('text-stone-400'); shelfCountSelect.disabled = true;
                 if (mugShelfSpecificOptionsContainer) mugShelfSpecificOptionsContainer.style.display = 'block';
                 if (mugShelfMountOptionsDiv) {
                     mugShelfMountOptionsDiv.style.display = 'block'; const defaultChecked = !isLoading ? 'checked' : '';
                     mugShelfMountOptionsDiv.innerHTML = `<h3 class="text-md font-semibold mb-2 text-stone-700">Sposób montażu:</h3><label class="flex items-center space-x-2"><input type="radio" name="mugShelfMount" value="hanging" class="rounded-full border-stone-300 text-green-600 shadow-sm focus:ring-green-500 focus:ring-offset-0 focus:ring-2" onchange="updatePreview(); updateOrderSummary(); updateMobileMountStripStates();"> <span>Wisząca</span></label><label class="flex items-center space-x-2 mt-1"><input type="radio" name="mugShelfMount" value="standing" class="rounded-full border-stone-300 text-green-600 shadow-sm focus:ring-green-500 focus:ring-offset-0 focus:ring-2" onchange="updatePreview(); updateOrderSummary(); updateMobileMountStripStates();" ${defaultChecked}><span>Stojąca</span></label>`;
                 }
                 if (mugShelfDividersOptionsDiv) mugShelfDividersOptionsDiv.style.display = 'none';
             }
             if (!isLoading) {
                  if (shelfType === 'standing' || shelfType === 'hanging') { if (Array.from(widthSelect.options).some(opt => opt.value === '44')) widthSelect.value = "44"; if (Array.from(heightSelect.options).some(opt => opt.value === '40')) heightSelect.value = "40"; updateDepthOptions(); if (Array.from(depthSelect.options).some(opt => opt.value === '10')) depthSelect.value = "10"; updateShelfCountOptions(); if (Array.from(shelfCountSelect.options).some(opt => opt.value === '0')) shelfCountSelect.value = "0";
                } else if (shelfType === 'mug_shelf') {
                    widthSelect.value = '44';
                    heightSelect.value = '40';
                    handleMugShelfHeightChange();
                    const standingRadio = mugShelfMountOptionsDiv?.querySelector('input[value="standing"]');
                    if (standingRadio && !standingRadio.checked) { standingRadio.checked = true;} else { const hangingRadio = mugShelfMountOptionsDiv?.querySelector('input[value="hanging"]'); if(hangingRadio) hangingRadio.checked = true; }
                }
                checkCustomWidth();
             }
             if (shelfColorLabel) { shelfColorLabel.textContent = (shelfType === 'mug_shelf') ? 'Kolor półek i przegródek:' : 'Kolor półek i podstaw:'; }
             if (!isLoading) { updatePreview(); updateOrderSummary(); }
             updateDividerIconsVisibility();
             if(shelfType === 'mug_shelf') updateMobileMountStripStates();
        }

        function handleMugShelfWidthChange() {
            const currentMugShelfWidth = widthSelect.value;
            let heightChangedProgrammatically = false;
            if (shelfTypeSelect && shelfTypeSelect.value === 'mug_shelf' && widthSelect && heightSelect) {
                const sixtyCmHeightOption = Array.from(heightSelect.options).find(opt => opt.value === '60');
                const fortyCmHeightOption = Array.from(heightSelect.options).find(opt => opt.value === '40');
                if (currentMugShelfWidth === '84') {
                    if (sixtyCmHeightOption) { sixtyCmHeightOption.disabled = true; sixtyCmHeightOption.style.textDecoration = 'line-through'; sixtyCmHeightOption.style.color = '#999'; }
                    if (heightSelect.value === '60' && sixtyCmHeightOption && sixtyCmHeightOption.disabled) {
                        if (fortyCmHeightOption && !fortyCmHeightOption.disabled) { heightSelect.value = '40'; heightChangedProgrammatically = true; }
                    }
                } else {
                    if (sixtyCmHeightOption) { sixtyCmHeightOption.disabled = false; sixtyCmHeightOption.style.textDecoration = ''; sixtyCmHeightOption.style.color = ''; }
                }
            }
            if (heightChangedProgrammatically && typeof handleMugShelfHeightChange === "function") { handleMugShelfHeightChange(); }
            if(dividersTopCheckbox) dividersTopCheckbox.checked = false;
            if(dividersMiddleCheckbox) dividersMiddleCheckbox.checked = false;
            if(dividersBottomCheckbox) dividersBottomCheckbox.checked = false;
            updatePreview();
            updateOrderSummary();
        }
        function restoreDimensionControls() { widthSelect.innerHTML = '<option value="">-- Wybierz --</option>'; originalWidthOptions.forEach(opt => widthSelect.add(new Option(opt.text, opt.value))); widthSelect.value = ""; widthSelect.removeEventListener('change', handleMugShelfWidthChange); widthSelect.removeEventListener('change', checkCustomWidth); widthSelect.addEventListener('change', checkCustomWidth); if(customWidthInput && customWidthDisplay && customWidthFee) { customWidthInput.style.display = 'none'; customWidthDisplay.style.display = 'none'; customWidthFee.style.display = 'none'; } heightSelect.innerHTML = '<option value="">-- Wybierz --</option>'; originalHeightOptions.forEach(opt => heightSelect.add(new Option(opt.text, opt.value))); heightSelect.value = ""; heightSelect.disabled = false; if(heightLabel) heightLabel.classList.remove('text-stone-400'); depthSelect.innerHTML = '<option value="">-- Wybierz --</option>'; depthSelect.value = ""; depthSelect.disabled = false; if(depthLabel) depthLabel.classList.remove('text-stone-400'); shelfCountSelect.innerHTML = '<option value="">-- Wybierz --</option>'; shelfCountSelect.value = ""; shelfCountSelect.disabled = false; heightSelect.removeEventListener('change', handleMugShelfHeightChange); heightSelect.removeEventListener('change', handleDimensionChange); heightSelect.addEventListener('change', handleDimensionChange); }
        function init3D() { const container = threeJsCanvasWrapper; if (!container) { console.error("Three.js canvas wrapper (#threeJsCanvasWrapper) not found."); return; } scene = new THREE.Scene(); scene.background = new THREE.Color(0xf0f0f0); camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000); camera.position.set(initialCameraPosition.x, initialCameraPosition.y, initialCameraPosition.z); renderer = new THREE.WebGLRenderer({ antialias: true }); renderer.setSize(container.clientWidth, container.clientHeight); container.innerHTML = ''; container.appendChild(renderer.domElement); scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1)); const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6); directionalLight.position.set(4, 8, 3); scene.add(directionalLight); controls = new THREE.OrbitControls(camera, renderer.domElement); controls.enableDamping = true; controls.target.set(0, 0, 0); if (controls) { controls.addEventListener('start', () => { autoRotateEnabled = false; }); controls.addEventListener('end', () => { if (shelfTypeSelect && shelfTypeSelect.value !== 'mug_shelf') { autoRotateEnabled = true; } else { autoRotateEnabled = false; } }); } window.addEventListener('resize', onWindowResize, false); updatePreview(); animate(); }
        function onWindowResize() { const container = threeJsCanvasWrapper; if (!camera || !renderer || !container) return; const width = container.clientWidth; const height = container.clientHeight; if (width > 0 && height > 0) { camera.aspect = width / height; camera.updateProjectionMatrix(); renderer.setSize(width, height); } else { console.warn("Skipping resize for 3D canvas wrapper with zero dimensions."); } updateDividerIconsVisibility(); }
        function animate() { requestAnimationFrame(animate); if (autoRotateEnabled && shelfGroup) { shelfGroup.rotation.y += 0.005; } if(controls) controls.update(); if(renderer && scene && camera) renderer.render(scene, camera); }
        function buildShelfModel(config) { const group = new THREE.Group(); const { width: widthNum, height: heightVal, depth: depthVal, shelfCount: shelfCountVal, shelfType, noTopShelf, noBottomShelf, addDividersTop, addDividersMiddle, addDividersBottom } = config; const thickness = 0.18; const width = widthNum / 10; const height = parseFloat(heightVal) / 10; const depth = parseFloat(depthVal) / 10; const shelfCount = parseInt(shelfCountVal); const defaultMaterial = new THREE.MeshStandardMaterial(originalPreviewMaterialParams); if (isNaN(width) || isNaN(height) || isNaN(depth) || width <= 0 || height <= 0 || depth <= 0) return group; let topPanel, bottomPanel; if (!noBottomShelf) { const bottomGeometry = new THREE.BoxGeometry(width, thickness, depth); bottomPanel = new THREE.Mesh(bottomGeometry, defaultMaterial); bottomPanel.position.set(0, -height / 2 + thickness / 2, 0); group.add(bottomPanel); } if (!noTopShelf) { const topGeometry = new THREE.BoxGeometry(width, thickness, depth); topPanel = new THREE.Mesh(topGeometry, defaultMaterial); topPanel.position.set(0, height / 2 - thickness / 2, 0); group.add(topPanel); } const sideGeometry = new THREE.BoxGeometry(thickness, height, depth); const leftSideMesh = new THREE.Mesh(sideGeometry, defaultMaterial); leftSideMesh.position.set(-width / 2 + thickness / 2, 0, 0); group.add(leftSideMesh); const rightSideMesh = new THREE.Mesh(sideGeometry, defaultMaterial); rightSideMesh.position.set(width / 2 - thickness / 2, 0, 0); group.add(rightSideMesh); const internalShelves = []; if (!isNaN(shelfCount) && shelfCount > 0) { if (shelfType === 'mug_shelf' && heightVal === '60' && shelfCount === 3 && topPanel) { const fixedGap = 1.09; const topPanelBottomY = topPanel.position.y - thickness / 2; let lastShelfY = topPanelBottomY; for (let i = 0; i < shelfCount; i++) { const shelfY = lastShelfY - fixedGap - thickness / 2; const shelfGeometry = new THREE.BoxGeometry(width - 2 * thickness, thickness, depth); const shelfMesh = new THREE.Mesh(shelfGeometry, defaultMaterial); shelfMesh.position.set(0, shelfY, 0); group.add(shelfMesh); internalShelves.push(shelfMesh); lastShelfY = shelfY - thickness / 2; } } else { const topExists = !!topPanel; const bottomExists = !!bottomPanel; const topThicknessActual = topExists ? thickness : 0; const bottomThicknessActual = bottomExists ? thickness : 0; const totalAvailableHeight = height - topThicknessActual - bottomThicknessActual; if (totalAvailableHeight >= shelfCount * thickness && (shelfCount + 1) > 0) { const gap = (totalAvailableHeight - shelfCount * thickness) / (shelfCount + 1); let startY = bottomExists ? (-height / 2 + bottomThicknessActual) : (-height / 2); for (let i = 1; i <= shelfCount; i++) { const shelfY = startY + i * gap + (i - 0.5) * thickness; const shelfGeometry = new THREE.BoxGeometry(width - 2 * thickness, thickness, depth); const shelfMesh = new THREE.Mesh(shelfGeometry, defaultMaterial); shelfMesh.position.set(0, shelfY, 0); group.add(shelfMesh); internalShelves.push(shelfMesh); } } } } if (shelfType === 'mug_shelf' && topPanel && bottomPanel && internalShelves.length > 0) { if (addDividersTop || addDividersMiddle || addDividersBottom) { const innerWidthForDividers = width - 2 * thickness; const dividerThicknessThreeJs = thickness; let levels = []; internalShelves.sort((a, b) => a.position.y - b.position.y); if (heightVal === '60' && internalShelves.length === 3) { levels = [ { top: topPanel.position.y - thickness / 2, bottom: internalShelves[2].position.y + thickness/2 }, { top: internalShelves[2].position.y - thickness/2, bottom: internalShelves[1].position.y + thickness/2 }, { top: internalShelves[1].position.y - thickness/2, bottom: internalShelves[0].position.y + thickness/2 }, { top: internalShelves[0].position.y - thickness/2, bottom: bottomPanel.position.y + thickness / 2 } ]; } else if (heightVal === '40' && internalShelves.length === 2) { levels = [ { top: topPanel.position.y - thickness / 2, bottom: internalShelves[1].position.y + thickness/2 }, { top: internalShelves[1].position.y - thickness/2, bottom: internalShelves[0].position.y + thickness/2 }, { top: internalShelves[0].position.y - thickness/2, bottom: bottomPanel.position.y + thickness / 2 } ]; } const drawDividersForLevel = (levelData) => { const levelH = Math.max(0.01, levelData.top - levelData.bottom); if (levelH <= 0.01) return; const yCenter = levelData.bottom + levelH / 2; const dividerGeometry = new THREE.BoxGeometry(dividerThicknessThreeJs, levelH, depth); if (widthNum == 84) { const numPhysicalDividers = 3; const singleCompartmentWidth = 1.25; let currentXPos = -innerWidthForDividers / 2; for (let i = 0; i < numPhysicalDividers; i++) { currentXPos += singleCompartmentWidth; const dividerXCenter = currentXPos + (dividerThicknessThreeJs / 2); const dividerMesh = new THREE.Mesh(dividerGeometry.clone(), defaultMaterial); dividerMesh.position.set(dividerXCenter, yCenter, 0); group.add(dividerMesh); currentXPos += dividerThicknessThreeJs; } } else { const numDividersOriginal = (widthNum == 60) ? 3 : ((widthNum == 44) ? 2 : 0); if (numDividersOriginal > 0) { const dividerSpacing = innerWidthForDividers / (numDividersOriginal + 1); for (let i = 1; i <= numDividersOriginal; i++) { const xPos = (-innerWidthForDividers / 2) + i * dividerSpacing; const dividerMesh = new THREE.Mesh(dividerGeometry.clone(), defaultMaterial); dividerMesh.position.set(xPos, yCenter, 0); group.add(dividerMesh); } } } }; if (addDividersTop && levels[0]) drawDividersForLevel(levels[0]); if (addDividersMiddle && levels[1]) drawDividersForLevel(levels[1]); if (addDividersBottom && levels[2]) drawDividersForLevel(levels[2]); } } return group; }
        function updatePreview() { updateDividerIconActiveStates(); if (!scene) return; if (shelfGroup) scene.remove(shelfGroup); const shelfType = shelfTypeSelect.value; const config = { width: getCurrentWidth(), height: heightSelect.value, depth: depthSelect.value, shelfCount: shelfCountSelect.value, shelfType: shelfType, noTopShelf: document.getElementById("noTopShelf")?.checked, noBottomShelf: (shelfType === "standing" && document.getElementById("noBottomShelf")?.checked), addDividersTop: shelfType === 'mug_shelf' && dividersTopCheckbox?.checked, addDividersMiddle: shelfType === 'mug_shelf' && dividersMiddleCheckbox?.checked, addDividersBottom: shelfType === 'mug_shelf' && dividersBottomCheckbox?.checked }; shelfGroup = buildShelfModel(config); shelfGroup.scale.set(1.2, 1.2, 1.2); shelfGroup.position.y = -1; scene.add(shelfGroup); }
        function generate3dSnapshotFromCurrentModel() { return new Promise((resolve, reject) => { if (!shelfGroup) { return reject(new Error("Główny model 3D (shelfGroup) nie istnieje.")); } const modelToClone = shelfGroup; const snapshotScene = new THREE.Scene(); snapshotScene.background = new THREE.Color(0xf5f5f4); const snapshotCamera = new THREE.PerspectiveCamera(35, 1, 0.1, 1000); snapshotCamera.position.set(12, 6, 12); snapshotCamera.lookAt(0, 0, 0); snapshotScene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.2)); const dirLight = new THREE.DirectionalLight(0xffffff, 0.8); dirLight.position.set(5, 10, 7.5); snapshotScene.add(dirLight); const clonedGroup = modelToClone.clone(true); clonedGroup.rotation.set(0, 0, 0); clonedGroup.scale.set(1, 1, 1); const box = new THREE.Box3().setFromObject(clonedGroup); const center = box.getCenter(new THREE.Vector3()); clonedGroup.position.sub(center); snapshotScene.add(clonedGroup); const snapshotRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true }); snapshotRenderer.setPixelRatio(window.devicePixelRatio); snapshotRenderer.setSize(128, 128); setTimeout(() => { try { snapshotRenderer.render(snapshotScene, snapshotCamera); const dataUrl = snapshotRenderer.domElement.toDataURL('image/png'); snapshotScene.traverse(object => { if (!object.isMesh) return; if (object.geometry) object.geometry.dispose(); if (object.material) { if (Array.isArray(object.material)) { object.material.forEach(material => material.dispose()); } else { object.material.dispose(); } } }); snapshotRenderer.dispose(); resolve(dataUrl); } catch (e) { snapshotRenderer.dispose(); reject(e); } }, 50); }); }
        function reset3DView() { if (controls && camera) { controls.reset(); camera.position.set(initialCameraPosition.x, initialCameraPosition.y, initialCameraPosition.z); controls.target.set(0, 0, 0); controls.update(); setActiveMobileIcon(null); if (shelfTypeSelect && shelfTypeSelect.value !== 'mug_shelf') { autoRotateEnabled = true; } } }
        function computePriceDetailed() { const shelfType = shelfTypeSelect.value; const widthVal = getCurrentWidth(); const heightVal = heightSelect.value; const depthVal = depthSelect.value; const shelfCountVal = shelfCountSelect.value; if (!shelfType || isNaN(widthVal) || !heightVal || !depthVal || !shelfCountVal || widthVal === "" || heightVal === "" || depthVal === "" || shelfCountVal === "" || (shelfType !== 'mug_shelf' && shelfCountVal === "0")) { return null; } let basePrice = null; let extraFee = 0; let deduction = 0; let dividerFee = 0; if (shelfType === 'mug_shelf') { const selectedMountRadio = document.querySelector('input[name="mugShelfMount"]:checked'); if (!selectedMountRadio) return null; if (mugShelfPricing[String(widthVal)]?.[heightVal] !== undefined) { basePrice = mugShelfPricing[String(widthVal)][heightVal]; } else { return null; } const dividersTopChecked = dividersTopCheckbox?.checked; const dividersMiddleChecked = dividersMiddleCheckbox?.checked; const dividersBottomChecked = dividersBottomCheckbox?.checked; if (widthVal == 84) { if (dividersTopChecked) dividerFee += 33; if (dividersMiddleChecked) dividerFee += 33; if (dividersBottomChecked) dividerFee += 33; } else { let feePerDividerRow = 0; if (widthVal == 44) feePerDividerRow = 27; else if (widthVal == 60) feePerDividerRow = 40; if (feePerDividerRow > 0) { if (dividersTopChecked) dividerFee += feePerDividerRow; if (dividersMiddleChecked) dividerFee += feePerDividerRow; if (dividersBottomChecked) dividerFee += feePerDividerRow; } } } else { let baseWidthKey; const isCustomWidth = widthSelect.value === 'custom'; if (isCustomWidth) { if (isNaN(widthVal) || widthVal < 35 || widthVal > 59) return null; baseWidthKey = widthVal < 39 ? "34" : widthVal < 47 ? "44" : widthVal < 54 ? "50" : "60"; extraFee = 50; } else { baseWidthKey = String(widthVal); } if (pricing[baseWidthKey]?.[heightVal]?.[depthVal]?.[shelfCountVal] !== undefined) { basePrice = pricing[baseWidthKey][heightVal][depthVal][shelfCountVal]; } else { return null; } if (document.getElementById('noTopShelf')?.checked) deduction += 10; if (shelfType === 'standing' && document.getElementById('noBottomShelf')?.checked) deduction += 10; } if (basePrice === null) return null; const totalPrice = basePrice + extraFee + dividerFee - deduction; return { base: basePrice, extra: extraFee, divider: dividerFee, deduction: deduction, total: Math.max(50, totalPrice) }; }
        function updateOrderSummary() { const shelfColorSummaryLabel = document.getElementById('shelfColorSummaryLabel'); const currentShelfType = shelfTypeSelect.value; if (shelfColorSummaryLabel) { if (currentShelfType === 'mug_shelf') shelfColorSummaryLabel.textContent = 'Kolor półek i przegródek:'; else shelfColorSummaryLabel.textContent = 'Kolor półek i podstaw:'; } document.getElementById("shelfTypeSummary").textContent = currentShelfType && shelfTypeSelect.selectedIndex > 0 ? shelfTypeSelect.options[shelfTypeSelect.selectedIndex].text : "-- Wybierz --"; const mugShelfMountItem = document.getElementById("mugShelfMountSummaryItem"); const mugShelfMountSummary = document.getElementById("mugShelfMountSummary"); if (currentShelfType === 'mug_shelf') { const selectedMountRadio = document.querySelector('input[name="mugShelfMount"]:checked'); mugShelfMountSummary.textContent = selectedMountRadio ? (selectedMountRadio.value === 'hanging' ? 'Wisząca' : 'Stojąca') : 'nie wybrano'; mugShelfMountItem.style.display = 'flex'; } else { mugShelfMountItem.style.display = 'none'; } const widthValue = getCurrentWidth(); const heightValue = heightSelect.value; const depthValue = depthSelect.value; const shelfCountValue = shelfCountSelect.value; document.getElementById("widthSummary").textContent = !isNaN(widthValue) ? widthValue + " cm" : "--"; document.getElementById("heightSummary").textContent = heightValue && heightValue !== "" ? heightValue + " cm" : "--"; document.getElementById("depthSummary").textContent = depthValue && depthValue !== "" ? depthValue + " cm" : "--"; document.getElementById("sideColorSummary").textContent = sideColorSelect.value && sideColorSelect.selectedIndex > 0 ? sideColorSelect.options[sideColorSelect.selectedIndex].text : "nie wybrano"; document.getElementById("shelfColorSummary").textContent = shelfColorSelect.value && shelfColorSelect.selectedIndex > 0 ? shelfColorSelect.options[shelfColorSelect.selectedIndex].text : "nie wybrano"; document.getElementById("shelfCountSummary").textContent = shelfCountValue !== "" ? (shelfCountSelect.options[shelfCountSelect.selectedIndex]?.text || '--') : '-- Wybierz --'; const h = parseFloat(heightValue); const sc = parseInt(shelfCountValue); const t = 1.8; let gT = "n/d"; if (!isNaN(h) && h > 0 && !isNaN(sc) && sc >= 0) { if (currentShelfType === 'mug_shelf') { const mugGapHeight = h - 2 * t; const mugGapFreeSpace = mugGapHeight - sc * t; const mugGapsCount = sc + 1; if (mugGapFreeSpace >=0 && mugGapsCount > 0) { gT = `ok. ${(mugGapFreeSpace / mugGapsCount).toFixed(1)} cm`; } else { gT = "za mało miejsca"; } } else { const displayGapHeight = h - 2 * t; const totalShelvesThickness = sc * t; if (displayGapHeight >= totalShelvesThickness && (sc + 1) > 0) { const freeSpace = displayGapHeight - totalShelvesThickness; const gapsCount = sc + 1; const calculatedGap = freeSpace / gapsCount; gT = `${calculatedGap.toFixed(1)} cm`; } else { gT = "za mało miejsca"; } } } else { gT = "wybierz H i S"; } document.getElementById("gapSummary").textContent = gT; document.getElementById("gapSummaryDisplay").textContent = gT; const gapSummaryLi = document.getElementById("gapSummary")?.parentElement; const gapDisplayP = document.getElementById("gapDisplay"); if (currentShelfType === 'mug_shelf') { if (gapSummaryLi) gapSummaryLi.style.display = 'none'; if (gapDisplayP) gapDisplayP.style.display = 'none'; } else { if (gapSummaryLi) gapSummaryLi.style.display = 'flex'; if (gapDisplayP) gapDisplayP.style.display = 'block'; } const o = []; if (currentShelfType === 'mug_shelf') { const selectedMount = document.querySelector('input[name="mugShelfMount"]:checked'); if (selectedMount) o.push(selectedMount.value === 'hanging' ? 'Montaż wiszący' : 'Montaż stojący'); const dividersSelected = []; if (dividersTopCheckbox?.checked) dividersSelected.push("góra"); if (dividersMiddleCheckbox?.checked) dividersSelected.push("środek"); if (dividersBottomCheckbox?.checked) dividersSelected.push("dół"); if (dividersSelected.length > 0) o.push("Przegródki: " + dividersSelected.join(", ")); } else { if (document.getElementById("noTopShelf")?.checked) o.push("bez górnej półki"); const isStandingType = (currentShelfType === "standing"); if (isStandingType && document.getElementById("noBottomShelf")?.checked) o.push("bez dolnej półki (podstawy)"); } document.getElementById("extraOptionsSummary").textContent = o.length ? o.join(" / ") : "standardowa"; if (mobileIconDetailsType) { if (shelfTypeSelect.selectedIndex > 0) { mobileIconDetailsType.textContent = shelfTypeSelect.options[shelfTypeSelect.selectedIndex].text.split(' ')[0]; mobileIconDetailsType.classList.remove('mobile-icon-prompt'); } else { mobileIconDetailsType.textContent = 'wybierz'; mobileIconDetailsType.classList.add('mobile-icon-prompt'); } } if (mobileIconDetailsDimensions) { if (!isNaN(widthValue) && heightValue && depthValue) { mobileIconDetailsDimensions.textContent = `${widthValue}x${heightValue}x${depthValue}`; mobileIconDetailsDimensions.classList.remove('mobile-icon-prompt'); } else { mobileIconDetailsDimensions.textContent = 'wybierz'; mobileIconDetailsDimensions.classList.add('mobile-icon-prompt'); } } if (mobileIconDetailsColors) { mobileIconDetailsColors.innerHTML = ''; const sideColorOption = sideColorSelect.options[sideColorSelect.selectedIndex]; const shelfColorOption = shelfColorSelect.options[shelfColorSelect.selectedIndex]; if (sideColorOption && sideColorOption.value && shelfColorOption && shelfColorOption.value) { const sideSwatch = document.createElement('span'); sideSwatch.className = 'mobile-color-swatch'; sideSwatch.style.backgroundColor = sideColorOption.dataset.color || '#ccc'; const shelfSwatch = document.createElement('span'); shelfSwatch.className = 'mobile-color-swatch'; shelfSwatch.style.backgroundColor = shelfColorOption.dataset.color || '#ccc'; mobileIconDetailsColors.appendChild(sideSwatch); mobileIconDetailsColors.appendChild(shelfSwatch); mobileIconDetailsColors.classList.remove('mobile-icon-prompt'); } else { mobileIconDetailsColors.textContent = 'wybierz'; mobileIconDetailsColors.classList.add('mobile-icon-prompt'); } } if (mobileIconDetailsShelves) { if (shelfCountValue !== "" && shelfCountSelect.options[shelfCountSelect.selectedIndex]) { const selectedText = shelfCountSelect.options[shelfCountSelect.selectedIndex].text; mobileIconDetailsShelves.textContent = selectedText; if (shelfCountValue === '0') { mobileIconDetailsShelves.classList.add('mobile-icon-prompt'); } else { mobileIconDetailsShelves.classList.remove('mobile-icon-prompt'); } } else { mobileIconDetailsShelves.textContent = 'wybierz'; mobileIconDetailsShelves.classList.add('mobile-icon-prompt'); } } const orderCode = generateOrderCode(); const isComplete = !!orderCode; if (isComplete) { const pD = computePriceDetailed(); if (pD !== null) { priceAndActionsContainer.style.display = 'block'; priceHint.style.display = 'none'; priceSummary.textContent = pD.total + " zł"; if (desktopCartContainer) { desktopCartContainer.classList.remove('animate-pulse-bg'); void desktopCartContainer.offsetWidth; desktopCartContainer.classList.add('animate-pulse-bg'); } if (mobile3dActionsContainer) mobile3dActionsContainer.style.display = 'flex'; if (mobilePriceValue) mobilePriceValue.textContent = pD.total + " zł"; } else { priceAndActionsContainer.style.display = 'none'; priceHint.textContent = "Błąd obliczania ceny. Sprawdź opcje."; priceHint.style.display = 'block'; if (mobile3dActionsContainer) mobile3dActionsContainer.style.display = 'none'; } } else { priceAndActionsContainer.style.display = 'none'; priceHint.textContent = "Wybierz wszystkie parametry, aby zobaczyć cenę."; priceHint.style.display = 'block'; if (mobile3dActionsContainer) mobile3dActionsContainer.style.display = 'none'; } updateDividerDimensionVisibility(); updateMobileShelfInfo(); }
        function generateOrderCode() { const shelfTypeVal = shelfTypeSelect.value; const widthNum = getCurrentWidth(); const heightVal = heightSelect.value; const depthVal = depthSelect.value; const shelfCountVal = shelfCountSelect.value; const sideColorVal = sideColorSelect.value || ''; const shelfColorVal = shelfColorSelect.value || ''; const isMugShelf = shelfTypeVal === 'mug_shelf'; if (!shelfTypeVal || isNaN(widthNum) || !heightVal || !depthVal || shelfCountVal === "" || !sideColorVal || !shelfColorVal) { return null; } const shelfCountNum = parseInt(shelfCountVal); if (isNaN(shelfCountNum) || shelfCountNum < 0) { return null; } if (!isMugShelf && shelfCountNum === 0) { return null; } let mugMountVal = null; if (isMugShelf) { mugMountVal = document.querySelector('input[name="mugShelfMount"]:checked')?.value; if (!mugMountVal) { return null; } } const typeCode = valueToCode.type[shelfTypeVal]; const sideColorCode = valueToCode.color[sideColorVal]; const shelfColorCode = valueToCode.color[shelfColorVal]; if (!typeCode || !sideColorCode || !shelfColorCode) { return null; } let optionsCode = ''; if (isMugShelf) { const mountCode = mugMountVal === 'hanging' ? 'h' : 's'; let dividerCode = ''; if (dividersTopCheckbox && dividersMiddleCheckbox && dividersBottomCheckbox) { if (dividersTopCheckbox.checked) dividerCode += 'g'; if (dividersMiddleCheckbox.checked) dividerCode += 'm'; if (dividersBottomCheckbox.checked) dividerCode += 'd'; } else { return null; } if (dividerCode === '') dividerCode = 'n'; optionsCode = `${mountCode}${dividerCode}`; } else { const noTop = document.getElementById("noTopShelf")?.checked; const noBottomCheck = document.getElementById("noBottomShelf"); const noBottom = (shelfTypeVal === "standing" && noBottomCheck?.checked); if (noTop && noBottom) optionsCode = 'tb'; else if (noTop) optionsCode = 't'; else if (noBottom) optionsCode = 'b'; else optionsCode = 's'; } const codeParts = [ typeCode, String(widthNum), heightVal, depthVal, String(shelfCountNum), sideColorCode, shelfColorCode, optionsCode ]; return codeParts.join('-'); }
        function parseOrderCode(code) { if (!code) return { error: "Kod jest pusty." }; code = code.trim().toLowerCase(); const parts = code.split('-'); if (parts.length !== 8) { return { error: `Nieprawidłowy format kodu (oczekiwano 8 części, znaleziono ${parts.length}).` }; } const [typeCode, widthStr, heightStr, depthStr, shelfCountStr, sideColorCode, shelfColorCode, optionsCode] = parts; const typeMap = { s: 'Stojąca na blacie', h: 'Wisząca', m: 'Półka na kubki' }; const colorMap = { '0': 'Dąb Craft Złoty', '1': 'Biały matowy', '2': 'Czarny matowy' }; const mugMountMap = { h: 'Wisząca', s: 'Stojąca' }; const shelfType = typeMap[typeCode]; const sideColor = colorMap[sideColorCode]; const shelfColor = colorMap[shelfColorCode]; const width = parseInt(widthStr); const height = parseInt(heightStr); const depth = parseInt(depthStr); const shelfCount = parseInt(shelfCountStr); if (!shelfType || !sideColor || !shelfColor || isNaN(width) || isNaN(height) || isNaN(depth) || isNaN(shelfCount)) { return { error: "Nieprawidłowe podstawowe wartości w kodzie (typ, wymiary, kolory lub liczba półek)." }; } if (width < 34 || (width > 60 && width !== 84) || (width > 84) || height < 40 || height > 80 || depth < 10 || depth > 15 || shelfCount < 0 || shelfCount > 5) { return { error: "Wartości wymiarów lub liczby półek poza dozwolonym zakresem." }; } let options = []; if (shelfType === 'Półka na kubki') { const mountCode = optionsCode.charAt(0); const dividerCode = optionsCode.substring(1); const mountType = mugMountMap[mountCode]; if (!mountType) return { error: `Nieprawidłowy kod montażu kubka: ${mountCode}.` }; options.push(`Montaż: ${mountType}`); const dividers = []; if (dividerCode.includes('g')) dividers.push("góra"); if (dividerCode.includes('m')) dividers.push("środek"); if (dividerCode.includes('d')) dividers.push("dół"); if (dividers.length > 0) options.push(`Przegródki: ${dividers.join(', ')}`); else if (dividerCode !== 'n') return { error: `Nieprawidłowy kod przegródek: ${dividerCode}.` }; } else { if (optionsCode === 't') options.push("Bez górnej półki"); else if (optionsCode === 'b' && shelfType === 'Stojąca na blacie') options.push("Bez dolnej półki (podstawy)"); else if (optionsCode === 'tb') { options.push("Bez górnej półki"); if (shelfType === 'Stojąca na blacie') options.push("Bez dolnej półki (podstawy)"); } else if (optionsCode !== 's') return { error: `Nieprawidłowy kod opcji: ${optionsCode}.` }; } if (options.length === 0 && optionsCode !== 's' && !(shelfType === 'Półka na kubki' && optionsCode.substring(1) === 'n')) { options.push("Standardowa"); } else if (options.length === 0) { options.push("Standardowa"); } return { code: code.toUpperCase(), shelfType, width: `${width} cm`, height: `${height} cm`, depth: `${depth} cm`, sideColor, shelfColor, shelfCount: `${shelfCount} szt.`, options: options.join(' / ') }; }
        function displayOrderDetailsInModal(details) { if (!orderDetailsModalOverlay || !orderDetailsModal || !modalOrderCodeSpan || !modalOrderSummaryP) return; if (details.error) { modalOrderCodeSpan.textContent = "BŁĄD"; modalOrderSummaryP.innerHTML = `<p class="text-red-600 font-semibold">${details.error}</p>`; } else { modalOrderCodeSpan.textContent = details.code; let summaryHtml = ` <p><strong>Rodzaj półki:</strong> ${details.shelfType}</p> <p><strong>Szerokość:</strong> ${details.width}</p> <p><strong>Wysokość:</strong> ${details.height}</p> <p><strong>Głębokość:</strong> ${details.depth}</p> <p><strong>Kolor boków:</strong> ${details.sideColor}</p> <p><strong>Kolor półek:</strong> ${details.shelfColor}</p> <p><strong>Ilość półek wewn.:</strong> ${details.shelfCount}</p> <p><strong>Opcje:</strong> ${details.options}</p> <p class="mt-4 text-xs text-stone-500 italic">Uwaga: Cena nie jest przechowywana w kodzie i nie jest tutaj wyświetlana.</p> `; modalOrderSummaryP.innerHTML = summaryHtml; } orderDetailsModalOverlay.classList.add('visible'); }
        function closeOrderDetailsModal() { if (!orderDetailsModalOverlay) return; orderDetailsModalOverlay.classList.remove('visible'); if (viewOrderCodeInput) viewOrderCodeInput.value = ''; }
        function updateSwatchDisplay(selectElementId, swatchDisplayId) { const selectElement = document.getElementById(selectElementId); const swatchDisplay = document.getElementById(swatchDisplayId); if (!selectElement || !swatchDisplay) return; const selectedOption = selectElement.options[selectElement.selectedIndex]; const color = selectedOption ? selectedOption.dataset.color : null; if (color) { swatchDisplay.style.backgroundColor = color; swatchDisplay.style.display = 'inline-block'; if (color.toUpperCase() === '#FFFFFF') { swatchDisplay.classList.add('swatch-white-display'); } else { swatchDisplay.classList.remove('swatch-white-display'); } } else { swatchDisplay.style.backgroundColor = '#E5E7EB'; swatchDisplay.classList.remove('swatch-white-display'); } }
        function closeDetailsPanelIfNeeded() { const detailsPanel = document.getElementById('materialSamplesDetails'); if (detailsPanel && detailsPanel.open) { detailsPanel.open = false; } }
        function setActiveMobileIcon(clickedButton) { const mobileIconsContainer = document.getElementById('mobilePanelIcons'); if (!mobileIconsContainer) return; const buttons = mobileIconsContainer.querySelectorAll('button'); buttons.forEach(button => { button.classList.remove('mobile-icon-active'); }); if (clickedButton && buttons.length > 0) { clickedButton.classList.add('mobile-icon-active'); } }
        function scrollToElementAndHighlight(elementId, blockPosition = 'start', clickedButton = null, inlinePosition = 'nearest') { const element = document.getElementById(elementId); if (element) { let highlightTarget = element.closest('.p-6.shadow.rounded-lg'); if (!highlightTarget) { highlightTarget = element.closest('.w-full.max-w-lg') || element; } document.querySelectorAll('.section-highlight-persistent').forEach(el => { if (el !== highlightTarget) { el.classList.remove('section-highlight-persistent'); } }); highlightTarget.scrollIntoView({ behavior: 'smooth', block: blockPosition, inline: inlinePosition }); if (clickedButton) { setActiveMobileIcon(clickedButton); } highlightTarget.classList.remove('section-highlight-flash'); void highlightTarget.offsetWidth; highlightTarget.classList.add('section-highlight-flash'); highlightTarget.classList.add('section-highlight-persistent'); setTimeout(() => { highlightTarget.classList.remove('section-highlight-flash'); }, 750); } else { console.error('Nie znaleziono elementu o ID do podświetlenia:', elementId); } }
        function scrollToElement(elementId, blockPosition = 'start', clickedButton = null, inlinePosition = 'nearest') { const element = document.getElementById(elementId); if (element) { let targetElement = element.closest('.p-6.shadow.rounded-lg') || element.closest('.w-full.max-w-lg') || element; targetElement.scrollIntoView({ behavior: 'smooth', block: blockPosition, inline: inlinePosition }); } else { console.error('Nie znaleziono elementu o ID (scrollToElement):', elementId); } }
        function scrollToBottom() { window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); }
        function openLightbox(imageSrc) { if (imageLightbox && lightboxImage) { lightboxImage.setAttribute('src', imageSrc); imageLightbox.classList.remove('hidden'); imageLightbox.classList.remove('opacity-0'); document.body.style.overflow = 'hidden'; } }
        function closeLightbox() { if (imageLightbox) { imageLightbox.classList.add('hidden'); imageLightbox.classList.add('opacity-0'); document.body.style.overflow = ''; } }
        function initializeTabbedGallery() { if (!galleryTabsContainer || !galleryGridContainer || !galleryImageArea || !configuratorSection || !galleryPrevArrow || !galleryNextArrow) { console.error("Nie znaleziono wszystkich elementów galerii potrzebnych do inicjalizacji."); return; } const scrollToConfig = () => { configuratorSection.scrollIntoView({ behavior: 'smooth', block: 'start' }); }; const displayImages = (galleryIndex) => { if (gallerySwiperInstance) { gallerySwiperInstance.destroy(true, true); gallerySwiperInstance = null; } galleryGridContainer.innerHTML = ''; const images = galleryData[galleryIndex].imgs; const fragment = document.createDocumentFragment(); images.forEach((imgDataOrSrc, i) => { const imgSrc = typeof imgDataOrSrc === 'string' ? imgDataOrSrc : imgDataOrSrc.src; const tileDiv = document.createElement('div'); tileDiv.className = 'gallery-tile swiper-slide'; const imgContainer = document.createElement('div'); imgContainer.className = 'gallery-image-container'; if (galleryIndex === 0 && i === 0) { const introTileDiv = document.createElement('div'); introTileDiv.className = 'gallery-intro-tile'; introTileDiv.innerHTML = `<p><strong>Kliknij w zdjęcie</strong>, by przerobić gotową półkę, lub <strong>zaprojektuj własną</strong> od nowa.</p>`; imgContainer.appendChild(introTileDiv); setTimeout(() => { introTileDiv.classList.add('is-animating'); }, 100); setTimeout(() => { introTileDiv.classList.add('fade-out'); }, 3500); } const img = document.createElement('img'); img.src = imgSrc; img.alt = `${galleryData[galleryIndex].title} - zdjęcie ${i + 1}`; img.loading = 'lazy'; imgContainer.appendChild(img); const actionBarHTML = ` <div class="image-actions-bar"> <button class="action-icon-btn gallery-zoom-btn" title="Powiększ"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6" /></svg> </button> <button class="action-icon-btn gallery-configure-btn" title="Konfiguruj"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 1.905c-.007.379.137.75.431.99l1.005.828c.428.355.53 1.005.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-1.905c.007-.379-.137-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg> </button> </div> `; imgContainer.insertAdjacentHTML('beforeend', actionBarHTML); const captionDiv = document.createElement('div'); captionDiv.className = 'gallery-caption'; captionDiv.textContent = 'Kliknij w ikonę, aby skonfigurować'; tileDiv.appendChild(imgContainer); tileDiv.appendChild(captionDiv); const currentZoomBtn = tileDiv.querySelector('.gallery-zoom-btn'); const currentConfigureBtn = tileDiv.querySelector('.gallery-configure-btn'); if (currentZoomBtn) { currentZoomBtn.addEventListener('click', (e) => { e.stopPropagation(); openLightbox(imgSrc); }); } if (currentConfigureBtn) { currentConfigureBtn.addEventListener('click', (e) => { e.stopPropagation(); document.querySelectorAll('.gallery-tile').forEach(t => t.classList.remove('gallery-tile--active')); tileDiv.classList.add('gallery-tile--active'); applyShelfConfigurationFromGallery(galleryIndex, i); scrollToConfig(); }); } fragment.appendChild(tileDiv); }); galleryGridContainer.appendChild(fragment); gallerySwiperInstance = new Swiper(galleryImageArea, { slidesPerView: 'auto', spaceBetween: 20, grabCursor: true, navigation: { nextEl: galleryNextArrow, prevEl: galleryPrevArrow, }, breakpoints: { 320: { slidesPerView: 'auto', spaceBetween: 10 }, 768: { slidesPerView: 'auto', spaceBetween: 20 }, } }); }; galleryData.forEach((gallery, index) => { const tab = document.createElement('button'); tab.className = 'gallery-tab'; tab.textContent = gallery.title; tab.dataset.index = index; if (index === 0) { tab.classList.add('active'); } tab.addEventListener('click', () => { galleryTabsContainer.querySelectorAll('.gallery-tab').forEach(t => t.classList.remove('active')); tab.classList.add('active'); displayImages(index); }); galleryTabsContainer.appendChild(tab); }); if (galleryData.length > 0) { displayImages(0); } }
        function initializeReviews() { const reviews = [ '"Fantastyczna półeczka, przyszła od razu zmontowana i idealnie pasuje w wielu miejscach. Serdecznie polecam!"', '"Piękna, zgrabna półka. Solidnie wykonana, bez żadnych wad. Polecam!"', '"Bardzo ładna i funkcjonalna półka, świetnie zapakowana na czas transportu. Polecam!"', '"Super produkt – pięknie wykonany, idealnie pasuje do małych słoiczków z przyprawami w kuchni. Polecam!"', '"Ładna i solidna półka, starannie wykonana. Kolor świetnie wpasował się w meble. Polecam!"' ]; let currentReviewIndex = 0; const reviewDisplay = document.getElementById('customerReview'); function showNextReview() { if (!reviewDisplay) return; reviewDisplay.classList.remove('review-fade-enter-active'); setTimeout(() => { const reviewData = reviews[currentReviewIndex]; reviewDisplay.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-lime-500 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg> ${reviewData}`; reviewDisplay.classList.add('review-fade-enter-active'); currentReviewIndex = (currentReviewIndex + 1) % reviews.length; }, 700); } if (reviewDisplay) { showNextReview(); setInterval(showNextReview, 6000); } }
        function open3dPanel() { if (shelfContainer) { shelfContainer.classList.add('active'); setTimeout(onWindowResize, 50); updateDividerIconsVisibility(); updateMobileMountStripStates(); } else { console.error("Nie można otworzyć panelu 3D - brak elementu #shelfContainer"); } }
        function close3dPanel() { if (shelfContainer) { shelfContainer.classList.remove('active'); setActiveMobileIcon(null); updateDividerIconsVisibility(); } }
        function initialize3dPanel() { show3dButton = document.getElementById('show3dButton'); collapse3dPanelButton = document.getElementById('collapse3dPanelButton'); if (show3dButton && collapse3dPanelButton && shelfContainer) { show3dButton.addEventListener('click', open3dPanel); console.log("Panel 3D zainicjalizowany."); } else { let missing = []; if (!show3dButton) missing.push("show3dButton"); if (!collapse3dPanelButton) missing.push("collapse3dPanelButton (lub jego odpowiednik)"); if (!shelfContainer) missing.push("shelfContainer"); console.warn(`Nie znaleziono elementów panelu 3D: ${missing.join(', ')}. Funkcjonalność może nie działać poprawnie.`); } }

        document.addEventListener('DOMContentLoaded', () => {
            const tickerContent = document.querySelector('.info-ticker-content');
            if (tickerContent) { tickerContent.innerHTML += tickerContent.innerHTML; }
            shelfContainer = document.getElementById('shelfContainer'); threeJsCanvasWrapper = document.getElementById('threeJsCanvasWrapper'); shelfTypeSelect = document.getElementById('shelfType'); widthSelect = document.getElementById('width'); heightSelect = document.getElementById('height'); depthSelect = document.getElementById('depth'); shelfCountSelect = document.getElementById('shelfCount'); customWidthInput = document.getElementById('customWidthInput'); customWidthDisplay = document.getElementById('customWidthDisplay'); customWidthFee = document.getElementById('customWidthFee'); shelfTypeOptionsDiv = document.getElementById('shelfTypeOptions'); widthSelectionArea = document.getElementById('widthSelectionArea'); dimensionSectionAnchor = document.getElementById('dimensionSectionAnchor'); colorSectionAnchor = document.getElementById('colorSectionAnchor'); shelfTypeSectionAnchor = document.getElementById('shelfTypeSectionAnchor'); heightLabel = document.getElementById('heightLabel'); depthLabel = document.getElementById('depthLabel'); sideColorSelect = document.getElementById('sideColor'); shelfColorSelect = document.getElementById('shelfColor'); mugShelfSpecificOptionsContainer = document.getElementById('mugShelfSpecificOptionsContainer'); mugShelfMountOptionsDiv = document.getElementById('mugShelfMountOptions'); mugShelfDividersOptionsDiv = document.getElementById('mugShelfDividersOptions'); dividersTopCheckbox = document.getElementById('dividersTop'); dividersMiddleCheckbox = document.getElementById('dividersMiddle'); dividersBottomCheckbox = document.getElementById('dividersBottom'); configuratorSection = document.getElementById('configuratorSection'); shelfCountSection = document.getElementById('shelfCountSection'); galleryTabsContainer = document.getElementById('galleryTabsContainer'); galleryGridContainer = document.getElementById('galleryGridContainer'); galleryImageArea = document.getElementById('galleryImageArea'); galleryPrevArrow = document.querySelector('.gallery-prev-arrow'); galleryNextArrow = document.querySelector('.gallery-next-arrow');
            mugShelfDividerIconsContainer = document.getElementById('mugShelfDividerIconsContainer'); dividerTooltip = document.getElementById('dividerTooltip'); addTopDividerBtn = document.getElementById('addTopDividerBtn'); addMiddleDividerBtn = document.getElementById('addMiddleDividerBtn'); addBottomDividerBtn = document.getElementById('addBottomDividerBtn'); mobileMugShelfMountPanel = document.getElementById('mobileMugShelfMountPanel'); mobileMountHangingStripBtn = document.getElementById('mobileMountHangingStripBtn'); mobileMountStandingStripBtn = document.getElementById('mobileMountStandingStripBtn');
            desktopDividerDimensionsInfo = document.getElementById('desktopDividerDimensionsInfo');
            viewOrderCodeInput = document.getElementById('viewOrderCodeInput'); orderDetailsModalOverlay = document.getElementById('orderDetailsModalOverlay'); orderDetailsModal = document.getElementById('orderDetailsModal'); modalCloseButton = orderDetailsModal ? orderDetailsModal.querySelector('.modal-close-button') : null; modalOrderCodeSpan = document.getElementById('modalOrderCode'); modalOrderSummaryP = document.getElementById('modalOrderSummary');
            imageLightbox = document.getElementById('imageLightbox'); lightboxImage = document.getElementById('lightboxImage'); lightboxCloseBtn = document.getElementById('lightboxClose');
            priceAndActionsContainer = document.getElementById('priceAndActionsContainer');
            priceHint = document.getElementById('priceHint');
            addToCartBtn = document.getElementById('addToCartBtn');
            mobileIconDetailsType = document.getElementById('mobileIconDetailsType');
            mobileIconDetailsDimensions = document.getElementById('mobileIconDetailsDimensions');
            mobileIconDetailsColors = document.getElementById('mobileIconDetailsColors');
            mobileIconDetailsShelves = document.getElementById('mobileIconDetailsShelves');
            mobile3dActionsContainer = document.getElementById('mobile3dActionsContainer');
            mobilePriceValue = document.getElementById('mobilePriceValue');
            mobileGoToSummaryBtn = document.getElementById('mobileGoToSummaryBtn');
            desktopCartContainer = document.getElementById('desktopCartContainer');
            cartPanel = document.getElementById('cartPanel');
            cartPanelOverlay = document.getElementById('cartPanelOverlay');
            cartPanelCloseBtn = document.getElementById('cartPanelCloseBtn');
            cartItemsContainer = document.getElementById('cartItemsContainer');
            cartEmptyMessage = document.getElementById('cartEmptyMessage');
            cartTotalPrice = document.getElementById('cartTotalPrice');
            cartCheckoutButton = document.getElementById('cartCheckoutButton');
            cartBadges = document.querySelectorAll('.cart-badge');
            mobileCartButton = document.getElementById('mobileCartButton');
            cartDiscountReminder = document.getElementById('cartDiscountReminder');
            cartSubtotalLine = document.getElementById('cartSubtotalLine');
            cartSubtotalPrice = document.getElementById('cartSubtotalPrice');
            cartDiscountLine = document.getElementById('cartDiscountLine');
            cartDiscountAmount = document.getElementById('cartDiscountAmount');
            cartSummaryModalOverlay = document.getElementById('cartSummaryModalOverlay');
            cartSummaryModal = document.getElementById('cartSummaryModal');
            cartSummaryModalTitle = document.getElementById('cartSummaryModalTitle');
            cartSummaryItemsContainer = document.getElementById('cartSummaryItemsContainer');
            cartSummaryTotalPrice = document.getElementById('cartSummaryTotalPrice');
            cartSummaryAllCodes = document.getElementById('cartSummaryAllCodes');
            copyAllCodesBtn = document.getElementById('copyAllCodesBtn');
            cartSummaryInstructionUnits = document.getElementById('cartSummaryInstructionUnits');
            downloadCartSummaryBtn = document.getElementById('downloadCartSummaryBtn');
            cartSummaryGoToAllegroBtn = document.getElementById('cartSummaryGoToAllegroBtn');
            cartSummaryModalCloseBtnTop = document.getElementById('cartSummaryModalCloseBtnTop');
            cartSummaryModalCloseBtnBottom = document.getElementById('cartSummaryModalCloseBtnBottom');
            cartSummarySubtotalLine = document.getElementById('cartSummarySubtotalLine');
            cartSummarySubtotalPrice = document.getElementById('cartSummarySubtotalPrice');
            cartSummaryDiscountLine = document.getElementById('cartSummaryDiscountLine');
            cartSummaryDiscountAmount = document.getElementById('cartSummaryDiscountAmount');

             if (!shelfContainer || !threeJsCanvasWrapper) { console.error("BŁĄD KRYTYCZNY: Nie znaleziono wszystkich wymaganych elementów DOM. Inicjalizacja przerwana."); return; }
             if(widthSelect) originalWidthOptions = Array.from(widthSelect.options).map(opt => ({value: opt.value, text: opt.text})).filter(opt => opt.value !== ""); if(heightSelect) originalHeightOptions = Array.from(heightSelect.options).map(opt => ({value: opt.value, text: opt.text})).filter(opt => opt.value !== "");

            try {
                if(typeof init3D === 'function') init3D(); else console.error("init3D is not defined");
                if(typeof updateSwatchDisplay === 'function') { updateSwatchDisplay('sideColor', 'sideColorSwatchDisplay'); updateSwatchDisplay('shelfColor', 'shelfColorSwatchDisplay'); } else console.error("updateSwatchDisplay is not defined");
                if(typeof initializeTabbedGallery === 'function') initializeTabbedGallery(); else console.error("initializeTabbedGallery is not defined");
                if(typeof initialize3dPanel === 'function') initialize3dPanel(); else console.error("initialize3dPanel is not defined");
                if(typeof initializeReviews === 'function') initializeReviews(); else console.error("initializeReviews is not defined");
                
                if (addToCartBtn) addToCartBtn.addEventListener('click', addToCart);
                if (mobileGoToSummaryBtn) mobileGoToSummaryBtn.addEventListener('click', () => scrollToElementAndHighlight('priceAndActionsContainer', 'center'));
                if (desktopCartContainer) desktopCartContainer.addEventListener('click', openCart);
                if (mobileCartButton) mobileCartButton.addEventListener('click', openCart);
                if (cartPanelCloseBtn) cartPanelCloseBtn.addEventListener('click', closeCart);
                if (cartPanelOverlay) cartPanelOverlay.addEventListener('click', closeCart);
                if (cartCheckoutButton) cartCheckoutButton.addEventListener('click', handleCheckout);
                updateCartDisplay(); 
                
                if (cartSummaryModalOverlay) {
                    cartSummaryModalOverlay.addEventListener('click', (event) => { if (event.target === cartSummaryModalOverlay) closeCartSummaryModal(); });
                    cartSummaryModalCloseBtnTop.addEventListener('click', closeCartSummaryModal);
                    cartSummaryModalCloseBtnBottom.addEventListener('click', closeCartSummaryModal);
                    downloadCartSummaryBtn.addEventListener('click', downloadFullCartSummary);
                    
                    copyAllCodesBtn.addEventListener('click', () => {
                        cartSummaryAllCodes.select();
                        navigator.clipboard.writeText(cartSummaryAllCodes.value);
                        const originalText = copyAllCodesBtn.innerHTML;
                        copyAllCodesBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;
                        setTimeout(() => { copyAllCodesBtn.innerHTML = originalText; }, 2000);
                    });

                    cartSummaryGoToAllegroBtn.addEventListener('click', () => {
                        navigator.clipboard.writeText(cartSummaryAllCodes.value).then(() => {
                           window.open("https://allegro.pl/oferta/zaprojektuj-wlasna-polke-podaj-wymiar-i-wybierz-kolory-do-kuchni-pokoju-17254488792", "_blank");
                           closeCartSummaryModal();
                        }).catch(err => {
                            alert('Nie udało się skopiować kodów. Spróbuj ręcznie, używając przycisku obok pola z kodami.');
                        });
                    });
                } else { console.error("Nie znaleziono elementów nowego modala podsumowania koszyka."); }

                if (shelfTypeSelect) { shelfTypeSelect.value = 'standing'; shelfTypeSelect.dispatchEvent(new Event('change', { bubbles: true })); }
                const setupDividerButton = (btn, checkbox) => { if (!btn || !checkbox) { return; } btn.addEventListener('click', () => { checkbox.checked = !checkbox.checked; updateDividerIconActiveStates(); updatePreview(); updateOrderSummary(); }); checkbox.addEventListener('change', () => { updateDividerIconActiveStates(); }); };
                setupDividerButton(addTopDividerBtn, dividersTopCheckbox);
                setupDividerButton(addMiddleDividerBtn, dividersMiddleCheckbox);
                setupDividerButton(addBottomDividerBtn, dividersBottomCheckbox);
                const setupMobileMountStrip = (stripBtn, mountValue) => { if (!stripBtn || !mugShelfMountOptionsDiv) { return; } stripBtn.addEventListener('click', () => { const radioToSelect = mugShelfMountOptionsDiv.querySelector(`input[name="mugShelfMount"][value="${mountValue}"]`); if (radioToSelect && !radioToSelect.checked) { radioToSelect.checked = true; radioToSelect.dispatchEvent(new Event('change', { bubbles: true })); } }); };
                setupMobileMountStrip(mobileMountHangingStripBtn, 'hanging');
                setupMobileMountStrip(mobileMountStandingStripBtn, 'standing');
                window.addEventListener('resize', updateDividerIconsVisibility);
                updateDividerIconsVisibility(); updateDividerIconActiveStates(); updateMobileMountStripStates(); updateDividerDimensionVisibility();
                const detailsPanel = document.getElementById('materialSamplesDetails'); if (detailsPanel) { detailsPanel.addEventListener('toggle', function initMaterialSwiperOnToggle() { if (detailsPanel.open && !materialSwiperInstance) { if (typeof Swiper === 'undefined') { console.error("Swiper library not loaded!"); return; } try { materialSwiperInstance = new Swiper('#materialSwiper', { slidesPerView: 1, spaceBetween: 10, navigation: { nextEl: '.material-swiper-button-next', prevEl: '.material-swiper-button-prev' }, observer: true, observeParents: true }); } catch (swiperError) { console.error("Błąd inicjalizacji Swipera:", swiperError); } } else if (detailsPanel.open && materialSwiperInstance) { materialSwiperInstance.update(); } }); document.addEventListener('click', function(event) { if (detailsPanel.open && !detailsPanel.contains(event.target)) { detailsPanel.open = false; } }); } else { console.warn("Element panelu próbek (#materialSamplesDetails) nie znaleziony."); }
                const formElementsToMonitor = document.querySelectorAll('#shelfType, #width, #customWidthInput, #height, #depth, #shelfCount, #sideColor, #shelfColor'); formElementsToMonitor.forEach(element => { const eventType = (element.type === 'range') ? 'input' : 'change'; element.addEventListener(eventType, closeDetailsPanelIfNeeded); }); const configPanelContainer = document.querySelector('.w-full.md\\:w-1\\/3.space-y-8'); if (configPanelContainer) { configPanelContainer.addEventListener('change', function(event) { if (event.target.matches('#shelfTypeOptions input[type="checkbox"], #mugShelfSpecificOptionsContainer input[type="checkbox"], #mugShelfSpecificOptionsContainer input[type="radio"]')) { closeDetailsPanelIfNeeded(); } }); } else { document.body.addEventListener('change', function(event) { if (event.target.matches('#noTopShelf, #noBottomShelf, #dividersTop, #dividersMiddle, #dividersBottom, input[name="mugShelfMount"]')) { closeDetailsPanelIfNeeded(); } }); }
                if (viewOrderCodeInput) { viewOrderCodeInput.addEventListener('paste', (event) => { const pastedText = (event.clipboardData || window.clipboardData).getData('text'); if (pastedText && pastedText.trim().length > 0) { setTimeout(() => { const details = parseOrderCode(viewOrderCodeInput.value); displayOrderDetailsInModal(details); viewOrderCodeInput.blur(); }, 50); } }); viewOrderCodeInput.addEventListener('input', (event) => { const code = event.target.value.trim(); if (code.length >= 15 && code.includes('-')) { const details = parseOrderCode(code); if (!details.error || (details.error && code.length > 5)) { displayOrderDetailsInModal(details); viewOrderCodeInput.blur(); } } }); viewOrderCodeInput.addEventListener('keydown', (event) => { if (event.key === 'Enter') { event.preventDefault(); const code = viewOrderCodeInput.value.trim(); if (code) { const details = parseOrderCode(code); displayOrderDetailsInModal(details); viewOrderCodeInput.blur(); } } }); } else { console.error("Nie znaleziono elementu #viewOrderCodeInput."); }
                if (modalCloseButton) { modalCloseButton.addEventListener('click', closeOrderDetailsModal); } else { console.error("Nie znaleziono przycisku zamykania modala szczegółów zamówienia."); }
                if (orderDetailsModalOverlay) { orderDetailsModalOverlay.addEventListener('click', (event) => { if (event.target === orderDetailsModalOverlay) { closeOrderDetailsModal(); } }); } else { console.error("Nie znaleziono elementu #orderDetailsModalOverlay."); }
                if (window.innerWidth < 768) { const reviewBlock = document.getElementById('customerReview')?.parentElement; const summarySection = document.querySelector('.w-full.md\\:w-1\\/3.order-3'); if (reviewBlock && summarySection && reviewBlock.parentElement !== summarySection) { summarySection.appendChild(reviewBlock); } }
                const mainConfigSection = document.getElementById('configuratorSection'); if (mainConfigSection) { mainConfigSection.addEventListener('change', function(event) { if (event.target.tagName === 'SELECT' && event.target.closest('.p-6.shadow.rounded-lg, .w-full.max-w-lg')) { const parentSection = event.target.closest('.section-highlight-persistent'); if (parentSection) { parentSection.classList.remove('section-highlight-persistent'); } } }); } else { console.error("Nie znaleziono głównego kontenera konfiguracji (#configuratorSection) do nasłuchiwania zmian."); }
                if (lightboxCloseBtn) { lightboxCloseBtn.addEventListener('click', closeLightbox); }
                if (imageLightbox) { imageLightbox.addEventListener('click', function(event) { if (event.target === imageLightbox) { closeLightbox(); } }); }
                document.addEventListener('keydown', function(event) { if (event.key === 'Escape' && imageLightbox && !imageLightbox.classList.contains('hidden')) { closeLightbox(); } });
                
                const scrollToCodesBtn = document.getElementById('scrollToCodesBtn');
                const codesSection = document.getElementById('codesSection');

                if (scrollToCodesBtn && codesSection) {
                    scrollToCodesBtn.addEventListener('click', () => {
                        codesSection.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                        scrollToCodesBtn.classList.remove('pulse-glow-animation', 'visible');
                    });
                }
                
                console.log("Inicjalizacja zakończona pomyślnie.");

             } catch (error) {
                 console.error("Błąd podczas inicjalizacji w DOMContentLoaded:", error);
                 const body = document.querySelector('body');
                 if (body) {
                     const errorMsg = document.createElement('p');
                     errorMsg.textContent = "Wystąpił błąd podczas ładowania konfiguratora. Spróbuj odświeżyć stronę.";
                     errorMsg.className = "text-red-600 font-bold text-center p-4 bg-red-100 fixed top-0 left-0 right-0 z-50";
                     body.prepend(errorMsg);
                 }
             }
        });
    </script>

    <div id="stickyFooterBar" class="fixed bottom-0 left-0 w-full bg-green-600 shadow-[0_-3px_6px_rgba(0,0,0,0.06)] flex justify-around items-stretch md:hidden z-50">
        <button onclick="scrollToElementAndHighlight('dimensionSectionAnchor', 'start', this)" title="Przewiń do wymiarów"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12h15m0 0l-6.75-6.75M19.5 12l-6.75 6.75" /> <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v16.5M20.25 3.75v16.5" /> </svg> <span>Wymiary</span> </button>
        <button onclick="scrollToElementAndHighlight('colorSectionAnchor', 'start', this)" title="Przewiń do kolorów"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.043-.025a15.994 15.994 0 011.622-3.395m3.42 3.42a15.995 15.995 0 004.764-4.648l3.876-5.814a1.151 1.151 0 00-1.597-1.597L14.146 6.32a15.996 15.996 0 00-4.649 4.763m3.42 3.42a6.776 6.776 0 00-3.42-3.42" /> </svg> <span>Kolory</span> </button>
        <button onclick="scrollToElementAndHighlight('shelfCountSection', 'center', this)" title="Przewiń do dodawania półek"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /> <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9h16.5M3.75 15h16.5" /> </svg> <span>Półki</span> </button>
        <button id="show3dButton" title="Pokaż/ukryj podgląd 3D"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="animate-spin-slow"> <path stroke-linecap="round" stroke-linejoin="round" d="M21 7.5l-9-5.25L3 7.5m18 0l-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9.75l-9 5.25M12 21v-9.75" /> </svg> <span>Zobacz 3D</span> </button>
        
        <button id="mobileCartButton" class="relative" title="Pokaż koszyk">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mb-1">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z" />
            </svg>
            <span class="mobile-cart-price text-xs font-bold">Koszyk</span>
            <span class="cart-badge" style="top: 0; right: 8px; width: 1rem; height: 1rem; font-size: 0.65rem; display: none;">0</span>
        </button>
    </div>

    </body>
</html>
