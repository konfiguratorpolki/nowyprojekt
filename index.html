function rebuildShelf(config, animate = true) {
    clearScene();
    const shelfType = config.shelfType;

    if (shelfType === 'modular') {
        shelfGroup = buildModularShelf(config);
    } else {
        shelfGroup = buildShelfModel(config);
    }

    if (shelfGroup) {
        const box = new THREE.Box3().setFromObject(shelfGroup);
        const center = box.getCenter(new THREE.Vector3());
        shelfGroup.position.sub(center);
        scene.add(shelfGroup);

        const isMobile = window.innerWidth < 768;

        if (shelfType === 'modular') {
            shelfGroup.scale.set(0.8, 0.8, 0.8);
            if (isMobile) {
                shelfGroup.position.y -= 1.0;
                controls.target.set(0, 0, 0);
            } else {
                controls.target.set(0, 0, 0);
            }

            if (animate) {
                const tl = gsap.timeline();
                const leftModule = shelfGroup.getObjectByName("leftModule");
                const rightModule = shelfGroup.getObjectByName("rightModule");
                const connectingShelves = shelfGroup.children.filter(child => child.name.startsWith("connecting_shelf_"));
                if (leftModule && rightModule) {
                    const leftTargetX = leftModule.position.x;
                    const rightTargetX = rightModule.position.x;
                    gsap.set(leftModule.position, { x: -20 });
                    gsap.set(rightModule.position, { x: 20 });
                    gsap.set(connectingShelves.map(s => s.scale), { x: 0.01 });
                    tl.to(leftModule.position, { x: leftTargetX, duration: 0.6, ease: 'power2.out' }, 0);
                    tl.to(rightModule.position, { x: rightTargetX, duration: 0.6, ease: 'power2.out' }, 0);
                    tl.to(connectingShelves.map(s => s.scale), { x: 1, duration: 0.5, stagger: 0.08, ease: 'power2.out' }, 0.3);
                }
            }
        } else {
            const isTallShelf = parseFloat(config.height) === 80;
            if (isMobile && isTallShelf) {
                shelfGroup.scale.set(1.0, 1.0, 1.0);
                shelfGroup.position.y -= 0.8;
                controls.target.set(0, 0, 0);
            } else {
                shelfGroup.scale.set(1.2, 1.2, 1.2);
                controls.target.set(0, 0, 0);
            }
        }
        controls.update();
    }
    lastValidConfig = { ...config };
}
